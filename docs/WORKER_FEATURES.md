# Worker 服务功能清单

> 更新时间: 2026-01-26

## 📋 功能概览

Worker 是 PIS 系统的核心图像处理服务，负责异步处理照片、管理上传、生成打包下载等功能。

---

## 🎯 核心功能

### 1. 📸 照片处理队列（BullMQ）

**功能**: 异步处理上传的照片

**处理流程**:
1. ✅ 下载原图
2. ✅ 提取 EXIF 信息（移除 GPS 隐私数据）
3. ✅ 应用 EXIF orientation 自动旋转
4. ✅ 应用手动旋转角度（如果设置）
5. ✅ 生成缩略图（400px）
6. ✅ 生成预览图（1920px，带水印）
7. ✅ 生成 BlurHash（用于占位符）
8. ✅ 上传处理后的图片到存储
9. ✅ 更新数据库状态

**配置**:
- 并发数: 5（可配置）
- 限流: 10 任务/秒
- 队列名: `photo-processing`

**API**: `POST /api/process`

---

### 2. 📦 打包下载队列

**功能**: 批量打包照片为 ZIP 文件供客户下载

**处理流程**:
1. ✅ 获取相册水印配置
2. ✅ 下载所有照片（原图/预览图）
3. ✅ 重新处理水印（如果需要）
4. ✅ 创建 ZIP 文件
5. ✅ 上传 ZIP 到存储
6. ✅ 生成预签名下载链接（15天有效期）

**支持选项**:
- ✅ 包含有水印版本
- ✅ 包含无水印版本（原图）
- ✅ 自定义文件夹结构

**配置**:
- 并发数: 2（资源消耗大）
- 队列名: `package-downloads`

**API**: `POST /api/package`

---

### 3. 📤 文件上传 API

#### 3.1 直接上传

**功能**: 接收文件并直接上传到存储

**流程**:
```
浏览器 → Next.js API → Worker API → MinIO/S3
```

**限制**:
- 最大文件大小: 100MB
- 支持所有文件类型

**API**: `PUT /api/upload?key=<file-key>`

---

#### 3.2 分片上传（Multipart Upload）

**功能**: 支持大文件分片上传，适合超大文件

**流程**:
1. 初始化上传 → 获取 `uploadId`
2. 上传分片1、分片2、...
3. 完成上传 → 合并所有分片

**优势**:
- ✅ 支持超大文件（理论上无限制）
- ✅ 可以断点续传
- ✅ 可以并行上传多个分片

**API**:
- `POST /api/multipart/init` - 初始化
- `PUT /api/multipart/upload` - 上传分片
- `POST /api/multipart/complete` - 完成上传
- `POST /api/multipart/abort` - 取消上传

---

### 4. 🔍 扫描同步功能

**功能**: 扫描存储中的文件，自动同步到数据库

**使用场景**:
- 通过其他方式上传的文件（如 FTP、命令行）
- 需要批量导入已有照片

**流程**:
1. ✅ 扫描指定相册的 `sync/{albumId}/` 目录
2. ✅ 过滤图片文件（jpg, png, heic, webp）
3. ✅ 检查是否已存在（通过文件名）
4. ✅ 复制到标准路径 `raw/{albumId}/{photoId}.{ext}`
5. ✅ 创建数据库记录
6. ✅ 添加到处理队列

**API**: `POST /api/scan`

---

### 5. 🗑️ 文件清理

**功能**: 删除存储中的文件

**使用场景**:
- 上传失败后清理
- 删除不需要的照片

**API**: `POST /api/cleanup-file`

---

### 6. 🔗 预签名 URL 生成

**功能**: 生成临时访问链接

**用途**:
- 直接上传到存储（绕过服务器）
- 临时下载链接

**API**: `POST /api/presign`

---

### 7. ❤️ 健康检查

**功能**: 检查服务状态和依赖服务

**检查项**:
- ✅ Redis 连接
- ✅ Supabase 连接
- ✅ 存储服务连接

**API**: `GET /health`

**响应示例**:
```json
{
  "status": "ok",
  "timestamp": "2026-01-26T04:34:09.632Z",
  "services": {
    "redis": { "status": "ok" },
    "supabase": { "status": "ok" },
    "storage": {
      "status": "ok",
      "bucket": "pis-photos",
      "type": "minio"
    }
  }
}
```

---

## 🛡️ 安全功能

### 1. API Key 认证

**功能**: 保护所有 API 端点（除了健康检查）

**实现**:
- 支持 `X-API-Key` 头
- 支持 `Authorization: Bearer <key>` 头

**配置**: `WORKER_API_KEY` 环境变量

---

### 2. 请求大小限制

**限制**:
- JSON 请求体: 10MB
- 文件上传: 100MB

**保护**: 防止 DoS 攻击

---

### 3. CORS 配置

**功能**: 控制跨域访问

**配置**: `CORS_ORIGINS` 环境变量（逗号分隔）

---

## 🎨 图像处理功能

### 1. 缩略图生成

- **尺寸**: 400px（保持宽高比）
- **格式**: JPEG
- **质量**: 80%

---

### 2. 预览图生成

- **尺寸**: 最大 1920px（保持宽高比）
- **格式**: JPEG
- **质量**: 85%
- **水印**: 支持（如果相册启用水印）

---

### 3. 水印处理

**支持**:
- ✅ 文本水印
- ✅ Logo 水印（图片）
- ✅ 多个水印（最多 6 个）
- ✅ 9 个位置（top-left, top-center, ...）
- ✅ 自定义透明度
- ✅ 自定义边距
- ✅ 并行处理（性能优化）

**安全**:
- ✅ SSRF 防护（Logo URL 验证）
- ✅ 内网地址拦截
- ✅ 域名白名单

---

### 4. EXIF 处理

**提取**:
- ✅ 相机信息
- ✅ 拍摄参数
- ✅ 拍摄时间

**清理**:
- ✅ 移除 GPS 地理位置信息（隐私保护）
- ✅ 移除敏感元数据

---

### 5. 旋转处理

**支持**:
- ✅ EXIF orientation 自动旋转
- ✅ 手动旋转角度（90°、180°、270°）
- ✅ 组合旋转（先 EXIF，再手动）

---

### 6. BlurHash 生成

**功能**: 生成模糊占位符

**用途**: 
- 图片加载前的占位符
- 提升用户体验

---

## 🔄 队列管理

### 1. 自动恢复

**功能**: 启动时自动恢复卡住的 `processing` 状态

**机制**:
- 启动后 5 秒执行
- 查找状态为 `processing` 且超过 1 小时的照片
- 重置为 `pending` 状态，重新处理

---

### 2. 错误处理

**功能**: 完善的错误处理和重试机制

**处理**:
- ✅ 文件不存在 → 清理数据库记录
- ✅ 上传失败 → 标记为 failed
- ✅ 处理失败 → 自动重试（BullMQ）

---

### 3. 优雅退出

**功能**: 安全关闭服务

**流程**:
1. 停止接受新请求
2. 等待正在处理的任务完成
3. 关闭所有队列连接
4. 关闭 HTTP 服务器

---

## 📊 存储支持

### 支持的存储后端

- ✅ **MinIO**（自托管）
- ✅ **Alibaba Cloud OSS**（阿里云）
- ✅ **Tencent Cloud COS**（腾讯云）
- ✅ **AWS S3**（兼容）

**抽象层**: 统一的存储接口，易于切换

---

## 🗄️ 数据库支持

### 支持的数据库

- ✅ **Supabase**（PostgreSQL，推荐）
- ✅ **PostgreSQL**（直接连接）
- ✅ **MySQL**（直接连接）

**抽象层**: 统一的数据库接口，易于切换

---

## 📈 性能特性

### 1. 并发处理

- 照片处理: 5 并发
- 打包下载: 2 并发

### 2. 限流

- 照片处理: 10 任务/秒

### 3. 并行操作

- ✅ 并行上传缩略图和预览图
- ✅ 并行处理多个水印
- ✅ 并行上传多个文件（前端）

---

## 🔧 配置选项

### 环境变量

- `WORKER_API_KEY` - API 认证密钥
- `MAX_BODY_SIZE` - JSON 请求体大小限制（默认 10MB）
- `MAX_UPLOAD_SIZE` - 文件上传大小限制（默认 100MB）
- `CORS_ORIGINS` - CORS 允许的来源
- `HTTP_PORT` - HTTP 服务器端口（默认 3001）

---

## 📝 API 端点总结

| 端点 | 方法 | 功能 | 需要认证 |
|------|------|------|---------|
| `/health` | GET | 健康检查 | ❌ |
| `/api/presign` | POST | 生成预签名 URL | ✅ |
| `/api/upload` | PUT | 直接上传文件 | ✅ |
| `/api/process` | POST | 触发照片处理 | ✅ |
| `/api/cleanup-file` | POST | 清理文件 | ✅ |
| `/api/multipart/init` | POST | 初始化分片上传 | ✅ |
| `/api/multipart/upload` | PUT | 上传分片 | ✅ |
| `/api/multipart/complete` | POST | 完成分片上传 | ✅ |
| `/api/multipart/abort` | POST | 取消分片上传 | ✅ |
| `/api/scan` | POST | 扫描同步文件 | ✅ |
| `/api/package` | POST | 创建打包下载 | ✅ |

---

## 🎯 使用场景

### 1. 照片上传流程

```
1. 前端上传文件 → Worker API
2. Worker 保存到存储
3. Worker 添加到处理队列
4. Worker 异步处理（生成缩略图、预览图）
5. 前端实时显示处理进度
```

### 2. 批量下载流程

```
1. 用户选择照片 → 创建打包任务
2. Worker 添加到打包队列
3. Worker 下载所有照片
4. Worker 创建 ZIP 文件
5. Worker 生成下载链接
6. 用户下载 ZIP 文件
```

### 3. 扫描同步流程

```
1. 通过 FTP/命令行上传到 sync/{albumId}/
2. 调用扫描 API
3. Worker 扫描文件
4. Worker 自动导入到数据库
5. Worker 添加到处理队列
```

---

## 📚 相关文档

- [Worker 深度审计](./WORKER_DEEP_AUDIT.md)
- [Worker 性能分析](./WORKER_PERFORMANCE_ANALYSIS.md)
- [Worker 安全修复](./WORKER_SECURITY_FIX.md)
- [Worker API Key 设置](./WORKER_API_KEY_SETUP.md)
- [上传性能优化](./UPLOAD_PERFORMANCE_OPTIMIZATION.md)

---

## 🔗 技术栈

- **运行时**: Node.js 20+
- **队列**: BullMQ (Redis)
- **图像处理**: Sharp
- **存储**: MinIO/S3/OSS/COS
- **数据库**: Supabase/PostgreSQL/MySQL
- **HTTP 服务器**: Node.js 原生 http 模块

---

## ✅ 总结

Worker 服务是 PIS 系统的核心，提供：

1. ✅ **异步照片处理** - 高性能、可扩展
2. ✅ **文件上传管理** - 支持直接上传和分片上传
3. ✅ **批量打包下载** - 专业照片交付
4. ✅ **扫描同步** - 灵活的导入方式
5. ✅ **安全保护** - API 认证、大小限制、CORS
6. ✅ **健康监控** - 完善的健康检查
7. ✅ **优雅退出** - 安全关闭机制

所有功能都经过优化，支持高并发、错误恢复和资源管理。
