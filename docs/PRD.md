# 📸 专业级私有化即时摄影分享系统 (PIS)

> **Note**: 本文档已由 Gemini 3 Pro 工程师审核并修订 (2026-01-22)。
> **Note**: 本文档已由 Claude 工程师复核并确认 (2026-01-22)。
> 
> **修订详情：**
> - **[Gemini 修改] 4.2 照片上传模块 (F-011)**：图片处理流水线增加“计算 BlurHash”步骤，优化加载体验。
> - **[Gemini 修改] 5.2 数据模型**：`photos` 表结构新增 `blur_data` (TEXT) 字段，用于存储 BlurHash 字符串。
> - **[Gemini 修改] 版本规划**：根据同事建议，将**水印功能**移至 v1.0 MVP。
> - **[Gemini 新增] 4.X 核心功能**：新增“公开相册广场”逻辑及 `is_public` 字段；新增“访客选片”逻辑及 `is_selected` 字段。
> - **[Claude 确认]**：已审核上述修改，确认技术方案合理，与 SCHEDULE.md / DEVELOPMENT.md 保持一致。
- **[Claude 新增] 2026-01-24**：新增相册模板功能 (F-006)、相册批量管理 (F-005)、照片批量管理增强 (F-024)。
- **[Claude 新增] 2026-01-24**：新增相册活动元数据（活动时间、地点）、照片和相册删除功能、修复照片查看客户端错误。

## 产品需求规格说明书 v1.5 (功能完成度更新)

> **最后更新**: 2026-01-24  
> **项目状态**: ✅ 核心功能开发完成，待部署上线

---

## 1. 产品概述

### 1.1 产品定位

本系统是一个专为摄影师打造的私有化照片交付工具。它通过 **Vercel** 实现高性能的前端展示，利用 **Supabase** 管理元数据与实时通信，并将庞大的照片资产存储在**内网 MinIO** 中，确保隐私与成本平衡。

### 1.2 目标用户

| 用户类型 | 描述 | 核心诉求 |
|----------|------|----------|
| 独立摄影师 | 婚礼/人像/商业摄影师 | 快速交付、品牌展示、成本可控 |
| 摄影工作室 | 团队协作的摄影机构 | 批量管理、客户分发、数据安全 |
| 客户/访客 | 照片接收方 | 便捷浏览、高清下载、即时获取 |

### 1.3 核心价值主张

- **即时性**：拍摄完成后分钟级交付，客户即刻可见
- **专业感**：沉浸式深色界面，突出照片本身
- **私有化**：数据存储在自有服务器，完全掌控
- **低成本**：利用内网存储，避免云存储高额费用

---

## 2. 角色与权限定义

### 2.1 管理员 (Admin/Owner)

| 权限项 | 描述 |
|--------|------|
| 相册管理 | 创建、编辑、删除相册 |
| 相册批量管理 | 批量选择、批量删除多个相册 |
| 相册模板 | 创建和管理相册配置模板，快速复用设置 |
| 相册活动元数据 | 设置活动时间和地点，展示在相册封面 |
| 照片管理 | 上传、删除、排序照片 |
| 照片批量管理 | 批量选择、批量删除、快速设置封面 |
| 照片删除 | 单张照片删除和批量删除 |
| 水印设置 | 配置文字/Logo 水印 |
| 下载控制 | 开启/关闭原图下载权限 |
| 系统设置 | 全局配置管理 |

### 2.2 访客 (Visitor)

| 权限项 | 描述 |
|--------|------|
| 相册浏览 | 通过 UUID 链接访问指定相册 |
| 照片预览 | 查看水印版大图 |
| 排序切换 | 按时间/手动顺序浏览 |
| 原图下载 | 受管理员控制的下载权限 |

### 2.3 访问控制模型

```
公开访问层
/ - 首页 (公开相册广场)，仅展示 is_public=true 的相册
/album/[slug] - 通过唯一链接访问 (无视 is_public 状态)

认证访问层
/admin/* - 需要 Supabase Auth 登录验证
```

---

## 3. UI/UX 交互设计规范

### 3.1 视觉风格

| 属性 | 规范 |
|------|------|
| **主题** | 深色模式 (Dark Mode) 为默认 |
| **背景色** | `#050505` (近乎纯黑) |
| **表面色** | `#0a0a0a` / `#111111` (卡片、弹窗) |
| **边框色** | `#1a1a1a` / `#222222` (极淡分隔) |
| **主强调色** | `#D4AF37` (金色，用于 CTA 按钮) |
| **文字色** | `#ffffff` (主) / `#888888` (次) |
| **标题字体** | *Noto Serif SC* / *Playfair Display* |
| **正文字体** | *Inter* / *SF Pro* |

### 3.2 设计原则

- **极简主义**：减少边框线，使用阴影和透明度区分层级
- **照片优先**：UI 元素尽量弱化，让照片成为绝对主角
- **毛玻璃效果**：`backdrop-filter: blur(20px)` 增加层次感
- **微动效**：淡入、缩放等细腻过渡，提升质感

### 3.3 关键页面设计

#### 3.3.1 访客相册页 `/album/[uuid]`

```
┌─────────────────────────────────────────────────────────────┐
│  [相册标题]                              [排序切换] [全屏]   │
├─────────────────────────────────────────────────────────────┤
│  ┌────────┐ ┌──────────────┐ ┌────────┐                     │
│  │        │ │              │ │        │                     │
│  │  Img1  │ │     Img2     │ │  Img3  │  ← 瀑布流布局       │
│  │        │ │              │ │        │    渐入动效         │
│  └────────┘ └──────────────┘ └────────┘                     │
│  ┌──────────────┐ ┌────────┐ ┌────────┐                     │
│  │              │ │        │ │        │                     │
│  │     Img4     │ │  Img5  │ │  Img6  │                     │
│  └──────────────┘ └────────┘ └────────┘                     │
│                        ...                                   │
│               [加载更多 / 无限滚动]                          │
└─────────────────────────────────────────────────────────────┘
```

#### 3.3.2 Lightbox 沉浸模式

```
┌─────────────────────────────────────────────────────────────┐
│ [×]                                                         │
│                                                             │
│                    ┌─────────────────┐                      │
│                    │                 │                      │
│        [←]        │   高清大图       │        [→]           │
│                    │   (90% 视口)    │                      │
│                    │                 │                      │
│                    └─────────────────┘                      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ f/2.8  |  1/200s  |  ISO 400  |  85mm f/1.4        │   │
│  │ ══════════════════════════════════ [⬇ 下载原图]    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 3.3.3 管理后台 `/admin`

```
┌──────────┬──────────────────────────────────────────────────┐
│          │  我的相册                          [+ 新建相册]  │
│  LOGO    ├──────────────────────────────────────────────────┤
│          │  ┌────────────┐ ┌────────────┐ ┌────────────┐   │
│  ──────  │  │ 🖼 婚礼    │ │ 🖼 人像    │ │ 🖼 商业    │   │
│  相册    │  │ 128 张     │ │ 64 张      │ │ 32 张      │   │
│  设置    │  │ 2024-01-15│ │ 2024-01-10│ │ 2024-01-05│   │
│  退出    │  └────────────┘ └────────────┘ └────────────┘   │
│          │                                                  │
└──────────┴──────────────────────────────────────────────────┘
```

---

## 4. 详细功能需求

### 4.1 相册管理模块

#### F-001 创建相册

| 属性 | 描述 |
|------|------|
| **触发** | 点击「+ 新建相册」按钮 |
| **输入** | 相册名称 (必填) |
| **输出** | 生成相册记录，返回 UUID 分享链接 |
| **规则** | 自动生成 slug UUID，默认开启瀑布流布局 |

#### F-002 相册设置

| 设置项 | 选项 | 默认值 |
|--------|------|--------|
| **公开状态** | 公开 (首页可见) / 私有 (仅链接访问) | 私有 |
| **布局模式** | 瀑布流 / 等高网格 / 大图轮播 | 瀑布流 |
| **排序规则** | 拍摄时间倒序 / 正序 / 手动排序 | 倒序 |
| **允许下载** | 开启 / 关闭 | 关闭 |
| **显示 EXIF** | 开启 / 关闭 | 开启 |

#### F-003 水印配置

| 模式 | 配置项 |
|------|--------|
| **文字水印** | 内容、字体大小 (12-48px)、透明度 (10%-100%)、位置 (9宫格) |
| **Logo 水印** | 图片上传、尺寸 (50-300px)、透明度、位置 |

#### F-004 相册删除

- 软删除：标记 `deleted_at` 时间戳
- 30 天后自动清理关联的 MinIO 文件

#### F-005 相册批量管理 (新)

| 功能 | 描述 |
|------|------|
| **批量选择** | 在相册列表页面进入批量管理模式，可多选相册 |
| **批量删除** | 选择多个相册后批量删除，最多支持 50 个 |
| **批量更新** | 批量更新相册设置（公开/私有、布局等） |

#### F-006 相册模板管理 (新)

| 功能 | 描述 |
|------|------|
| **创建模板** | 在系统设置页面创建相册配置模板 |
| **模板配置** | 保存布局、水印、访问控制等设置 |
| **使用模板** | 创建新相册时选择模板，自动应用配置 |
| **模板管理** | 编辑、删除已有模板 |

### 4.2 照片上传模块

#### F-010 分片上传

| 属性 | 规格 |
|------|------|
| **支持格式** | JPG, JPEG, PNG, HEIC, RAW (转换后存储) |
| **单文件上限** | 100MB |
| **分片大小** | 5MB |
| **并发数** | 3 线程 |
| **断点续传** | 支持 |

#### F-011 图片处理流水线

```
原图上传 → 存储原图 → 生成缩略图/预览图 → 计算 BlurHash → 提取 EXIF → 实时推送
             │            │                │            │
             ▼            ▼                ▼            ▼
          original/    thumb/preview    photos.blur_data  photos.exif
```

#### F-012 EXIF 提取字段

| 字段 | 用途 | 示例 |
|------|------|------|
| DateTimeOriginal | 拍摄时间 | 2024-01-15 14:30:00 |
| Make | 相机品牌 | Canon |
| Model | 相机型号 | EOS R5 |
| LensModel | 镜头型号 | RF 85mm F1.2L |
| FNumber | 光圈值 | f/1.2 |
| ExposureTime | 快门速度 | 1/200 |
| ISO | 感光度 | 400 |
| FocalLength | 焦距 | 85mm |

### 4.3 访客浏览模块

#### F-020 相册浏览

| 功能 | 描述 |
|------|------|
| **瀑布流加载** | 首屏加载 20 张缩略图，滚动加载更多 |
| **懒加载** | 使用 Intersection Observer，视口外图片不加载 |
| **渐入动效** | 图片进入视口时 `opacity: 0 → 1`，`translateY: 20px → 0` |
| **排序切换** | 访客可切换「最新优先」或「按拍摄顺序」 |

#### F-021 Lightbox 大图

| 功能 | 描述 |
|------|------|
| **开启方式** | 点击任意缩略图 |
| **导航** | 左右箭头、键盘 ←→、触摸滑动 |
| **缩放** | 双击放大、双指捏合 (移动端) |
| **EXIF 显示** | 底部半透明条显示关键参数 |
| **关闭方式** | 点击 ×、按 ESC、点击背景 |

#### F-022 原图下载

| 步骤 | 描述 |
|------|------|
| 1 | 用户点击「下载原图」按钮 |
| 2 | 前端请求后端 API |
| 3 | 后端生成 5 分钟有效的 Presigned URL |
| 4 | Nginx 添加 `Content-Disposition: attachment` |
| 5 | 浏览器开始下载 |

#### F-023 访客选片 (新)

| 步骤 | 描述 |
|------|------|
| 1 | 访客点击照片上的“心形”图标 |
| 2 | 照片 `is_selected` 状态翻转 |
| 3 | 管理后台可筛选显示“客户已选”照片 |

### 4.4 实时推送模块

#### F-030 Supabase Realtime

| 事件 | 触发条件 | 前端响应 |
|------|----------|----------|
| INSERT | 新照片处理完成 | 瀑布流顶部插入新图，带动效 |
| UPDATE | 照片信息更新 | 刷新对应卡片 |
| DELETE | 照片被删除 | 移除对应卡片，带消失动效 |

---

## 5. 技术架构设计

### 5.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户层                                      │
│    ┌──────────────┐                          ┌──────────────┐           │
│    │   管理员      │                          │    访客      │           │
│    │  (浏览器)     │                          │  (浏览器)    │           │
│    └──────┬───────┘                          └──────┬───────┘           │
└───────────┼──────────────────────────────────────────┼──────────────────┘
            │                                          │
            ▼                                          ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            Vercel (前端)                                 │
│    ┌────────────────────────────────────────────────────────────┐       │
│    │                    Next.js 15 App Router                    │       │
│    │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │       │
│    │  │ /admin   │  │ /album   │  │ /api     │  │ 静态资源  │   │       │
│    │  │ 管理后台  │  │ 访客页面  │  │ 边缘函数  │  │ CDN 加速  │   │       │
│    │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │       │
│    └────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
            │                                          │
            ▼                                          ▼
┌───────────────────────────────┐    ┌────────────────────────────────────┐
│       Supabase Cloud          │    │         内网服务器 (宝塔)           │
│  ┌─────────┐  ┌────────────┐ │    │  ┌──────────┐  ┌──────────────┐   │
│  │PostgreSQL│ │  Realtime  │ │    │  │  MinIO   │  │ Node Worker  │   │
│  │ 元数据   │  │  实时订阅  │ │    │  │ 图片存储  │  │  图片处理    │   │
│  └─────────┘  └────────────┘ │    │  └──────────┘  └──────────────┘   │
│  ┌─────────┐  ┌────────────┐ │    │  ┌──────────────────────────────┐ │
│  │  Auth   │  │  Storage   │ │    │  │         Nginx 反代           │ │
│  │ 身份认证 │  │ (备用)     │ │    │  │   media.yourdomain.com      │ │
│  └─────────┘  └────────────┘ │    │  └──────────────────────────────┘ │
└───────────────────────────────┘    └────────────────────────────────────┘
```

### 5.2 数据模型

```sql
-- 启用 UUID 扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 相册表
CREATE TABLE albums (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  slug UUID UNIQUE DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  description TEXT,
  cover_photo_id UUID,
  
  -- 显示设置
  is_public BOOLEAN DEFAULT false, -- 是否在首页广场展示
  layout TEXT DEFAULT 'masonry' CHECK (layout IN ('masonry', 'grid', 'carousel')),
  sort_rule TEXT DEFAULT 'capture_desc' CHECK (sort_rule IN ('capture_desc', 'capture_asc', 'manual')),
  allow_download BOOLEAN DEFAULT false,
  show_exif BOOLEAN DEFAULT true,
  
  -- 水印配置
  watermark_enabled BOOLEAN DEFAULT false,
  watermark_type TEXT CHECK (watermark_type IN ('text', 'logo')),
  watermark_config JSONB DEFAULT '{}',
  
  -- 元数据
  photo_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  deleted_at TIMESTAMPTZ
);

-- 照片表
CREATE TABLE photos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  album_id UUID NOT NULL REFERENCES albums(id) ON DELETE CASCADE,
  
  -- 存储路径
  original_key TEXT NOT NULL,
  preview_key TEXT,
  thumb_key TEXT,
  
  -- 图片信息
  filename TEXT NOT NULL,
  file_size BIGINT,
  width INTEGER,
  height INTEGER,
  mime_type TEXT,
  blur_data TEXT, -- BlurHash 字符串
  
  -- EXIF 数据
  exif JSONB DEFAULT '{}',
  captured_at TIMESTAMPTZ,
  
  -- 处理状态
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  
  -- 交互状态
  is_selected BOOLEAN DEFAULT false, -- 访客选片状态
  
  -- 排序
  sort_order INTEGER DEFAULT 0,
  
  -- 元数据
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_albums_slug ON albums(slug) WHERE deleted_at IS NULL;
CREATE INDEX idx_photos_album_id ON photos(album_id);
CREATE INDEX idx_photos_captured_at ON photos(captured_at DESC);
CREATE INDEX idx_photos_status ON photos(status);
```

### 5.3 API 设计

#### 管理端 API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/admin/albums` | 获取所有相册列表 |
| POST | `/api/admin/albums` | 创建新相册 |
| GET | `/api/admin/albums/[id]` | 获取相册详情 |
| PATCH | `/api/admin/albums/[id]` | 更新相册设置 |
| DELETE | `/api/admin/albums/[id]` | 删除相册 (软删除) |
| POST | `/api/admin/albums/[id]/upload` | 获取上传凭证 |
| DELETE | `/api/admin/photos/[id]` | 删除单张照片 |
| PATCH | `/api/admin/photos/reorder` | 批量更新排序 |

#### 访客端 API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/albums/[slug]` | 获取相册公开信息 |
| GET | `/api/albums/[slug]/photos` | 获取照片列表 (分页) |
| GET | `/api/photos/[id]/download` | 获取下载 Presigned URL |

---

## 6. 非功能性需求

### 6.1 性能需求

| 指标 | 目标值 |
|------|--------|
| 首屏加载时间 (FCP) | < 1.5s |
| 最大内容绘制 (LCP) | < 2.5s |
| 缩略图加载 | < 500ms (CDN 缓存后) |
| 大图加载 | < 2s (2560px 预览图) |
| 上传速度 | > 5MB/s (内网环境) |
| Lighthouse 评分 | > 90 |

### 6.2 安全需求

| 需求 | 实现方式 |
|------|----------|
| 管理端认证 | Supabase Auth (邮箱+密码) |
| 相册访问控制 | UUID 不可枚举，无公开列表 |
| 下载保护 | Presigned URL，5 分钟过期 |
| HTTPS | 全链路 SSL/TLS |
| CORS | 仅允许指定域名 |

### 6.3 可用性需求

| 指标 | 目标值 |
|------|--------|
| 服务可用性 | > 99.5% |
| 数据持久性 | > 99.99% |
| 故障恢复时间 | < 30 分钟 |

### 6.4 兼容性需求

| 平台 | 支持范围 |
|------|----------|
| 桌面浏览器 | Chrome 90+, Firefox 90+, Safari 14+, Edge 90+ |
| 移动浏览器 | iOS Safari 14+, Chrome for Android 90+ |
| 屏幕尺寸 | 320px - 2560px 响应式 |

---

## 7. 版本规划

### v1.0 MVP (本期)

- [x] 相册 CRUD + 公开/私有设置
- [x] 基础水印功能 (文字/Logo)
- [x] 照片上传与处理
- [x] 瀑布流浏览 + 公开广场
- [x] Lightbox 大图 + 访客选片
- [x] 原图下载
- [x] 实时推送

### v1.1 (后续)

- [ ] 批量下载 (ZIP)
- [ ] 照片拖拽排序
- [ ] 多管理员协作

### v1.2 (远期)

- [ ] 多管理员协作
- [ ] 访客密码保护
- [ ] 照片评论/收藏
- [ ] 数据统计面板

---

## 8. 验收标准

### 8.1 功能验收

| 测试场景 | 预期结果 |
|----------|----------|
| 创建相册 | 成功创建，获得分享链接 |
| 上传 100 张照片 | 全部处理完成，无丢失 |
| 访客打开链接 | 1.5s 内看到首屏内容 |
| 点击查看大图 | 流畅切换，EXIF 正确显示 |
| 点击下载 | 成功下载原图 |
| 实时上传 | 访客端即时看到新图 |

### 8.2 性能验收

| 测试项 | 方法 | 通过标准 |
|--------|------|----------|
| 首屏性能 | Lighthouse | FCP < 1.5s, LCP < 2.5s |
| 并发访问 | 压测 100 用户 | 响应时间 < 500ms |
| 大文件上传 | 上传 50MB RAW | 完成无错误 |

---

## 附录 A: 术语表

| 术语 | 定义 |
|------|------|
| PIS | Private Instant photo Sharing，私有化即时摄影分享 |
| Slug | 相册的外部分享标识符 (UUID) |
| Presigned URL | MinIO 生成的带签名临时访问链接 |
| Lightbox | 大图沉浸式查看模式 |
| EXIF | 照片的元数据信息 (相机、镜头、参数等) |

---

## 附录 B: 参考资料

- [Next.js 15 文档](https://nextjs.org/docs)
- [Supabase 文档](https://supabase.com/docs)
- [MinIO 文档](https://min.io/docs/minio/linux/index.html)
- [Sharp 图片处理](https://sharp.pixelplumbing.com/)
