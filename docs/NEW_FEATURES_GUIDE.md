# 新功能使用指南

> 本文档介绍 PIS 系统新增功能的详细使用方法

## 📦 打包下载功能

### 功能说明

打包下载功能允许管理员将相册中的照片打包成 ZIP 文件下载，支持同时包含有水印和无水印两个版本。

### 使用方法

1. **进入相册详情页**
   - 在相册列表点击任意相册
   - 或直接访问 `/admin/albums/[id]`

2. **创建打包任务**
   - 点击右上角的"打包下载"按钮
   - 选择要打包的照片：
     - **已选照片**：只打包客户已选的照片
     - **全部照片**：打包相册中的所有照片
   - 选择包含版本：
     - ✅ **有水印版本**：包含水印的预览图
     - ✅ **无水印版本**：原始高清图片
   - 点击"创建打包"

3. **等待处理**
   - 系统会显示处理状态（等待处理 → 正在打包 → 打包完成）
   - 处理时间取决于照片数量（通常每张照片 1-3 秒）

4. **下载 ZIP 文件**
   - 打包完成后，点击"下载 ZIP 文件"按钮
   - ZIP 文件包含两个文件夹：
     - `有水印/` - 包含水印的照片
     - `无水印/` - 原始照片

### 注意事项

- ⏱️ 下载链接有效期为 **15 天**，过期后需重新打包
- 📦 单次最多打包 **500 张照片**
- 💾 ZIP 文件会占用服务器存储空间，建议定期清理
- 🔄 如果打包失败，可以重新创建打包任务

---

## 🎨 多位置水印功能

### 功能说明

支持在照片的多个位置同时添加水印，最多支持 6 个水印，每个水印可独立配置。

### 使用方法

1. **进入相册设置**
   - 在相册详情页点击"设置"按钮
   - 或访问 `/admin/albums/[id]/settings`

2. **启用水印**
   - 在"水印设置"部分，打开"水印设置"开关

3. **添加水印**
   - 点击"添加水印"按钮
   - 配置水印：
     - **类型**：选择"文字"或"Logo"
     - **位置**：选择9个位置之一（左上、上中、右上、左中、居中、右中、左下、下中、右下）
     - **内容**：
       - 文字水印：输入文字内容（如：© Your Name）
       - Logo 水印：输入 Logo 图片的 URL
     - **透明度**：拖动滑块调整（10%-100%）

4. **管理水印**
   - 可以添加多个水印（最多 6 个）
   - 每个水印可以单独启用/禁用
   - 点击"删除"按钮移除不需要的水印

5. **保存设置**
   - 点击"保存设置"按钮
   - 系统会自动重新处理相册中的所有照片

### 水印位置说明

```
┌─────────┬─────────┬─────────┐
│ 左上    │  上中    │  右上   │
├─────────┼─────────┼─────────┤
│ 左中    │  居中    │  右中   │
├─────────┼─────────┼─────────┤
│ 左下    │  下中    │  右下   │
└─────────┴─────────┴─────────┘
```

### 使用场景

- **品牌保护**：在多个位置添加 Logo 和版权信息
- **双重水印**：文字 + Logo 组合使用
- **灵活布局**：根据照片内容选择最佳水印位置

### 注意事项

- 🎯 最多支持 **6 个水印**同时存在
- 🔄 修改水印配置后，需要重新处理照片（自动触发）
- 📐 Logo 水印建议使用 PNG 透明底图
- 💡 水印大小会根据照片尺寸自动调整

---

## 📱 微信分享优化

### 功能说明

自定义分享到微信、朋友圈等社交平台时显示的卡片信息（标题、描述、图片）。

### 使用方法

1. **进入相册设置**
   - 在相册详情页点击"设置"按钮

2. **配置分享信息**
   - 在"分享设置"部分：
     - **分享标题**：自定义分享卡片标题（留空则使用相册标题）
     - **分享描述**：自定义分享卡片描述（留空则使用相册描述）
     - **分享图片 URL**：自定义分享卡片图片（留空则使用封面图）

3. **保存设置**
   - 点击"保存设置"按钮

### 分享卡片预览

分享卡片会显示：
- **标题**：自定义标题或相册标题
- **描述**：自定义描述或相册描述
- **图片**：自定义图片或封面图（建议尺寸：1200x630px）

### 自动回退机制

如果未设置自定义分享信息，系统会自动使用：
- 标题 → 相册标题
- 描述 → 相册描述或默认文案
- 图片 → 封面图或默认图片

### 注意事项

- 📐 分享图片建议尺寸：**1200x630px**（Open Graph 标准）
- 🔗 分享图片必须是可公开访问的 URL
- 🖼️ 如果相册有封面图，会自动使用封面图作为分享图片

---

## 📋 相册复制功能

### 功能说明

一键复制相册的所有配置，快速创建具有相同设置的新相册。

### 使用方法

1. **在相册列表中**
   - 将鼠标悬停在相册卡片上
   - 右上角会显示"复制"按钮（📋 图标）

2. **复制相册**
   - 点击"复制"按钮
   - 确认复制操作
   - 系统会自动创建新相册并跳转

### 复制内容

✅ **会复制**：
- 相册标题（自动添加"副本"后缀）
- 相册描述
- 所有设置（布局、排序、访问控制、水印、分享配置等）

❌ **不会复制**：
- 照片
- 封面图
- 统计数据（照片数量、浏览量等）

### 使用场景

- **批量创建**：快速创建多个相同配置的相册
- **模板复用**：将配置好的相册作为模板
- **活动系列**：为同一活动的不同阶段创建相册

---

## 🎯 相册模板功能

### 功能说明

创建和管理相册配置模板，在创建新相册时快速应用预设配置。

### 使用方法

1. **创建模板**
   - 进入"系统设置" → "相册模板"
   - 点击"新建模板"
   - 输入模板名称和描述
   - 点击"创建"

2. **从相册保存模板**
   - 在相册设置页面配置好所有选项
   - 点击"保存为模板"（功能待完善）

3. **使用模板创建相册**
   - 在相册列表页面点击"新建相册"
   - 在创建对话框中选择模板
   - 模板的配置会自动应用到新相册

### 模板管理

- **编辑模板**：点击模板卡片的编辑按钮
- **删除模板**：点击模板卡片的删除按钮
- **查看模板**：在模板列表中查看所有模板

---

## 🔄 相册批量管理

### 功能说明

支持在相册列表页面批量选择和操作多个相册。

### 使用方法

1. **进入批量管理模式**
   - 在相册列表页面点击"批量管理"按钮

2. **选择相册**
   - 点击相册卡片进行选择
   - 可以多选多个相册

3. **批量操作**
   - **批量删除**：选择相册后点击"删除"按钮
   - 确认删除操作

4. **退出批量模式**
   - 点击"取消"按钮退出批量管理模式

### 注意事项

- 🚫 单次最多删除 **50 个相册**
- ⚠️ 删除操作不可恢复（软删除，数据保留但隐藏）
- 🔄 批量操作后会自动刷新列表

---

## 📸 照片批量管理增强

### 功能说明

在相册详情页面增强照片批量操作功能。

### 使用方法

1. **进入批量选择模式**
   - 在相册详情页点击"选择"按钮

2. **选择照片**
   - 点击照片进行选择
   - 可以多选多张照片

3. **批量操作**
   - **快速设置封面**：选择单张照片时，显示"设为封面"按钮
   - **批量删除**：选择多张照片后，点击"删除"按钮

4. **退出批量模式**
   - 点击"取消"按钮退出批量选择模式

### 注意事项

- 📌 设置封面功能仅在选择单张照片时显示
- 🚫 单次最多删除 **100 张照片**
- ⚠️ 删除操作不可恢复

---

## 🛠️ 技术细节

### 数据库迁移

运行以下迁移文件以启用新功能：

```sql
-- 1. 相册模板功能
database/migrations/004_album_templates.sql

-- 2. 打包下载功能
database/migrations/005_package_downloads.sql

-- 3. 分享配置功能
database/migrations/006_album_share_config.sql
```

### Worker 依赖

确保 Worker 服务已安装 archiver 库：

```bash
cd services/worker
pnpm install
```

### 环境变量

确保以下环境变量已配置：

```bash
# Worker API URL（用于触发打包任务）
WORKER_API_URL=http://localhost:3001

# 应用 URL（用于生成分享链接）
NEXT_PUBLIC_APP_URL=https://yourdomain.com

# 媒体文件 URL（用于分享图片）
NEXT_PUBLIC_MEDIA_URL=https://media.yourdomain.com/pis-photos
```

---

## ❓ 常见问题

### Q: 打包下载失败怎么办？

1. 检查 Worker 服务是否正常运行
2. 检查照片是否都已处理完成（status = 'completed'）
3. 检查 MinIO 存储空间是否充足
4. 重新创建打包任务

### Q: 多水印不显示？

1. 确认已启用水印设置
2. 确认每个水印都已启用（眼睛图标）
3. 检查水印配置是否正确（文字内容或 Logo URL）
4. 等待照片重新处理完成

### Q: 微信分享卡片不显示自定义图片？

1. 确认分享图片 URL 可公开访问
2. 检查图片尺寸是否符合要求（建议 1200x630px）
3. 清除微信缓存后重试
4. 使用微信开发者工具调试分享卡片

### Q: 相册复制后没有照片？

这是正常行为。相册复制功能只复制配置，不复制照片。如果需要照片，请：
1. 使用模板功能创建新相册
2. 手动上传照片到新相册

---

## 📚 相关文档

- [开发文档](./DEVELOPMENT.md) - 开发环境搭建和代码规范
- [功能对比](./FEATURE_COMPARISON.md) - 与拍立享的功能对比
- [部署指南](./DEPLOYMENT.md) - 生产环境部署说明

---

**最后更新**：2026-01-24
