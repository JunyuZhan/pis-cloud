# PIS ç«¯å£é…ç½®è¯´æ˜

## ğŸ“‹ ç«¯å£åˆ†é…

ä¸ºäº†é¿å…ä¸å…¶ä»–åº”ç”¨å†²çªï¼ŒPIS ç³»ç»Ÿä½¿ç”¨ç‹¬ç«‹ç«¯å£ï¼š

| æœåŠ¡ | å†…éƒ¨ç«¯å£ | å¤–éƒ¨ç«¯å£ | è¯´æ˜ |
|------|---------|---------|------|
| **MinIO API** | 9000 | **19000** | å¯¹è±¡å­˜å‚¨ APIï¼ˆé€šè¿‡ Nginx åä»£ï¼‰ |
| **MinIO Console** | 9001 | **19001** | MinIO ç®¡ç†æ§åˆ¶å° |
| **Redis** | 6379 | **16379** | ä»»åŠ¡é˜Ÿåˆ—æœåŠ¡ |
| **Worker HTTP API** | 3001 | **3001** | Worker HTTP æ¥å£ |

## ğŸ”§ é…ç½®è¯´æ˜

### Docker å†…éƒ¨é€šä¿¡

å®¹å™¨ä¹‹é—´ä½¿ç”¨**æœåŠ¡å**å’Œ**å†…éƒ¨ç«¯å£**é€šä¿¡ï¼š
- MinIO: `minio:9000`
- Redis: `redis:6379`

### å¤–éƒ¨è®¿é—®

å¤–éƒ¨è®¿é—®ä½¿ç”¨**å¤–éƒ¨ç«¯å£**ï¼š
- MinIO API: `localhost:19000`
- MinIO Console: `localhost:19001`
- Redis: `localhost:16379`ï¼ˆé€šå¸¸ä¸éœ€è¦å¤–éƒ¨è®¿é—®ï¼‰

## ğŸŒ Nginx åå‘ä»£ç†é…ç½®

å¦‚æœä½¿ç”¨ Nginx åå‘ä»£ç† MinIOï¼Œéœ€è¦é…ç½®ï¼š

```nginx
# MinIO API åå‘ä»£ç†
upstream pis_minio {
    server 127.0.0.1:19000;  # æ³¨æ„ï¼šä½¿ç”¨ 19000 è€Œä¸æ˜¯ 9000
    keepalive 32;
}

server {
    listen 443 ssl http2;
    server_name media.yourdomain.com;
    
    location / {
        proxy_pass http://pis_minio;
        # ... å…¶ä»–é…ç½®
    }
}
```

## ğŸ” æ£€æŸ¥ç«¯å£å ç”¨

éƒ¨ç½²å‰æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tuln | grep -E "19000|19001|16379|3001"
# æˆ–
ss -tuln | grep -E "19000|19001|16379|3001"

# å¦‚æœç«¯å£è¢«å ç”¨ï¼Œå¯ä»¥ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„
```

## ğŸ“ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `/opt/pis/.env` æ–‡ä»¶ä¸­ï¼š

```bash
# MinIO é…ç½®ï¼ˆWorker å†…éƒ¨ä½¿ç”¨ï¼‰
MINIO_ENDPOINT_HOST=minio
MINIO_ENDPOINT_PORT=9000  # å†…éƒ¨ç«¯å£ï¼Œä¸è¦æ”¹
MINIO_ACCESS_KEY=your-access-key
MINIO_SECRET_KEY=your-secret-key

# Redis é…ç½®ï¼ˆWorker å†…éƒ¨ä½¿ç”¨ï¼‰
REDIS_HOST=redis
REDIS_PORT=6379  # å†…éƒ¨ç«¯å£ï¼Œä¸è¦æ”¹
```

**æ³¨æ„**ï¼šç¯å¢ƒå˜é‡ä¸­çš„ç«¯å£æ˜¯ Docker å†…éƒ¨ç«¯å£ï¼Œä¸éœ€è¦ä¿®æ”¹ã€‚å¤–éƒ¨ç«¯å£åœ¨ `docker-compose.yml` ä¸­é…ç½®ã€‚

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **æ£€æŸ¥ç«¯å£å ç”¨**ï¼š
   ```bash
   netstat -tuln | grep -E "19000|19001|16379"
   ```

2. **å¯åŠ¨æœåŠ¡**ï¼š
   ```bash
   cd /opt/pis/docker
   docker-compose up -d
   ```

3. **éªŒè¯ç«¯å£ç›‘å¬**ï¼š
   ```bash
   # æ£€æŸ¥å¤–éƒ¨ç«¯å£
   netstat -tuln | grep -E "19000|19001|16379|3001"
   
   # æµ‹è¯•æœåŠ¡
   curl http://localhost:19000/minio/health/live
   docker exec pis-redis redis-cli -p 6379 ping
   curl http://localhost:3001/health
   ```

4. **é…ç½® Nginx**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   - ä¿®æ”¹ Nginx é…ç½®ï¼Œä½¿ç”¨ `127.0.0.1:19000` è€Œä¸æ˜¯ `127.0.0.1:9000`

## ğŸ”’ å®‰å…¨å»ºè®®

- æ‰€æœ‰ç«¯å£åªç›‘å¬ `127.0.0.1`ï¼Œä¸æš´éœ²åˆ°å…¬ç½‘
- MinIO Console (19001) å»ºè®®é™åˆ¶ IP è®¿é—®
- Redis (16379) é€šå¸¸ä¸éœ€è¦å¤–éƒ¨è®¿é—®ï¼Œå¯ä»¥ç§»é™¤ç«¯å£æ˜ å°„

## ğŸ› å¸¸è§é—®é¢˜

### Q: ç«¯å£å†²çªæ€ä¹ˆåŠï¼Ÿ

å¦‚æœ 19000ã€19001ã€16379 ä¹Ÿè¢«å ç”¨ï¼Œå¯ä»¥ä¿®æ”¹ `docker-compose.yml`ï¼š

```yaml
ports:
  - "127.0.0.1:29000:9000"  # æ”¹ä¸ºå…¶ä»–ç«¯å£
  - "127.0.0.1:29001:9001"
```

### Q: Worker æ— æ³•è¿æ¥ MinIO/Redisï¼Ÿ

æ£€æŸ¥ï¼š
1. å®¹å™¨æ˜¯å¦åœ¨åŒä¸€ç½‘ç»œï¼š`docker network inspect pis-network`
2. æœåŠ¡åæ˜¯å¦æ­£ç¡®ï¼š`docker exec pis-worker ping minio`
3. ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®ï¼š`docker exec pis-worker env | grep MINIO`

### Q: Nginx æ— æ³•è®¿é—® MinIOï¼Ÿ

ç¡®ä¿ Nginx é…ç½®ä¸­ä½¿ç”¨çš„æ˜¯å¤–éƒ¨ç«¯å£ `19000`ï¼Œè€Œä¸æ˜¯å†…éƒ¨ç«¯å£ `9000`ã€‚
