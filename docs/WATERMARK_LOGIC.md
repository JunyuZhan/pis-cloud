# 水印功能逻辑说明

> **最后更新**: 2026-01-24  
> **重要**: 水印配置只应用于设置后上传的新照片

---

## 📋 核心原则

**水印配置变更后，只对新上传的照片生效，已上传的照片不会被重新处理。**

---

## 🔧 工作原理

### 1. 照片上传流程

```
用户上传照片
    ↓
照片保存到 MinIO（原图）
    ↓
创建照片记录（status: 'pending'）
    ↓
Worker 处理任务触发
    ↓
Worker 读取相册当前水印配置
    ↓
应用水印到预览图（如果启用了水印）
    ↓
生成缩略图和预览图
    ↓
更新照片状态（status: 'completed'）
```

### 2. 水印配置变更

```
管理员修改相册水印设置
    ↓
更新相册的 watermark_config
    ↓
✅ 只影响之后上传的新照片
❌ 不会重新处理已上传的照片
```

---

## 📝 代码实现

### Worker 处理逻辑

**文件**: `services/worker/src/index.ts`

```typescript
// 照片处理时，Worker 读取相册当前的水印配置
const { data: album } = await supabase
  .from('albums')
  .select('watermark_enabled, watermark_type, watermark_config')
  .eq('id', albumId)
  .single();

// 应用水印到新上传的照片
const result = await processor.process(watermarkConfig);
```

### API 更新逻辑

**文件**: `apps/web/src/app/api/admin/albums/[id]/route.ts`

```typescript
// ✅ 正确：只更新配置，不重新处理已上传的照片
// 注意：水印配置变更后，只对新上传的照片生效
// 已上传的照片不会被重新处理，避免数据库错误和性能问题
// 水印配置会在照片上传时由 Worker 读取并应用

return NextResponse.json({
  ...album,
  message: '设置已更新。水印配置将应用于之后上传的新照片。'
})
```

---

## ⚠️ 为什么不能重新处理已上传的照片？

### 1. 数据库状态冲突

如果重新处理已完成的照片：
- 照片状态从 `completed` → `processing` → `completed`
- 可能导致状态不一致
- 可能触发数据库约束错误

### 2. 性能问题

- 重新处理大量照片会消耗大量资源
- 可能导致 Worker 队列阻塞
- 影响新照片的上传和处理

### 3. 数据一致性

- 已上传的照片可能已经被用户查看或下载
- 重新处理会改变预览图和缩略图
- 可能导致用户看到的内容不一致

---

## 🎯 打包下载的特殊处理

**文件**: `services/worker/src/package-creator.ts`

打包下载时：
1. **如果预览图存在**：直接使用预览图（已处理过水印）
2. **如果预览图不存在**：临时处理添加水印（仅用于下载，不更新数据库）

```typescript
if (photo.previewKey) {
  // 使用已处理的预览图
  watermarkedBuffer = await downloadFile(photo.previewKey);
} else {
  // 临时处理添加水印（仅用于下载）
  const processor = new PhotoProcessor(originalBuffer);
  const result = await processor.process(watermarkConfig);
  watermarkedBuffer = result.previewBuffer;
}
```

**注意**: 这种临时处理不会更新数据库，只是为下载包生成有水印的版本。

---

## ✅ 正确的工作流程

### 场景1：上传照片前设置水印

1. 管理员设置相册水印配置
2. 用户上传照片
3. Worker 读取当前水印配置
4. ✅ 照片处理时应用水印

### 场景2：上传照片后设置水印

1. 用户上传照片（无水印）
2. 照片处理完成（status: 'completed'）
3. 管理员设置相册水印配置
4. ✅ 已上传的照片保持不变（无水印）
5. ✅ 之后上传的新照片会应用水印

### 场景3：修改水印配置

1. 相册已有水印配置
2. 已上传的照片已应用旧水印
3. 管理员修改水印配置
4. ✅ 已上传的照片保持旧水印
5. ✅ 之后上传的新照片会应用新水印

---

## 📊 数据流图

```
┌─────────────────┐
│  管理员设置水印  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  更新相册配置    │
│ watermark_config │
└────────┬────────┘
         │
         │ 只影响新照片
         ▼
┌─────────────────┐      ┌──────────────┐
│  用户上传照片    │─────▶│ Worker处理   │
└─────────────────┘      └──────┬───────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ 读取当前水印配置 │
                        └──────┬──────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ 应用水印到预览图│
                        └─────────────────┘
```

---

## 🔍 验证清单

- [x] Worker 在照片上传时读取水印配置
- [x] API 更新水印配置时不重新处理已上传照片
- [x] 打包下载时使用已处理的预览图
- [x] 已上传的照片不会被修改
- [x] 新上传的照片会应用当前水印配置

---

## 📝 用户提示

当管理员修改水印配置时，系统会显示：

> "设置已更新。水印配置将应用于之后上传的新照片。"

这明确告知用户：
- ✅ 设置已保存
- ✅ 只影响新照片
- ✅ 已上传的照片不会改变

---

**最后更新**: 2026-01-24
