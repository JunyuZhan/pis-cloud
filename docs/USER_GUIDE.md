# PIS 新功能使用指南

## 📸 图片风格预设功能

### 功能概述
PIS 现在支持为相册应用预设的图片风格（类似 Lightroom 预设），可以自动调整照片的亮度、对比度、饱和度、色调等参数，实现统一的视觉风格。

### 可用预设风格

#### 人像类（Portrait）
1. **清新人像** - 明亮、清新的色调，适合户外人像
2. **日系人像** - 柔和、温暖的日系风格
3. **写实人像** - 自然、真实的色彩还原
4. **暖调人像** - 温暖的色调，适合室内人像
5. **冷调人像** - 清爽的冷色调，适合时尚摄影

#### 风景类（Landscape）
1. **自然风景** - 增强自然色彩，适合户外风景
2. **城市风光** - 增强对比度，突出城市建筑
3. **日落风景** - 增强暖色调，突出日落氛围
4. **清新风景** - 明亮、清新的自然色调

#### 通用类（General）
1. **标准** - 轻微增强，适合大多数场景
2. **高对比** - 增强对比度，突出细节
3. **柔和** - 降低对比度，柔和画面

### 使用方法

#### 1. 创建相册时选择风格

1. 登录管理后台
2. 点击「新建相册」
3. 填写相册基本信息（标题、描述等）
4. 在「风格设置（可选）」区域：
   - 点击展开风格选择器
   - 浏览可用的预设风格
   - 点击选择你想要的风格
   - 可以点击「长按对比原图」查看效果预览
5. 点击「创建相册」

**注意**：
- 如果选择了模板，批量下载设置会继承模板配置
- 如果不选择模板，可以单独设置批量下载权限

#### 2. 为现有相册更改风格

1. 进入相册详情页
2. 点击「设置」按钮
3. 在「风格设置」区域：
   - 点击展开风格选择器
   - 选择新的风格预设
   - 或选择「无风格」移除风格
4. 如果相册中已有照片，系统会提示：
   - 「检测到风格设置已更改，是否重新处理所有照片以应用新风格？」
   - 点击「是」开始重新处理
   - 重新处理会在后台异步进行，不会影响其他操作
5. 点击「保存」保存设置

#### 3. 重新处理相册照片

如果更改了相册的风格设置，需要重新处理照片才能应用新风格：

1. 在相册设置页面更改风格后，系统会自动提示
2. 或者手动触发：
   - 进入相册设置页面
   - 更改风格设置
   - 保存时会提示重新处理
3. 重新处理过程：
   - 所有已完成状态的照片会被重新处理
   - 处理在后台队列中进行
   - 可以继续使用系统，不影响其他操作
   - 处理完成后，照片会自动更新

### 风格预览功能

在风格选择器中：
- **实时预览**：选择风格后，示例图片会实时显示效果
- **对比原图**：长按示例图片可以对比原图和风格效果
- **分类浏览**：风格按「人像」、「风景」、「通用」分类显示

---

## 📥 批量下载功能

### 功能概述
访客可以一键下载相册中所有已选中的照片。此功能需要管理员在相册设置中明确开启。

### 管理员设置

#### 1. 创建相册时设置

1. 创建新相册时，在「批量下载设置」区域：
   - 默认状态：**关闭**（需要管理员明确开启）
   - 点击开关按钮开启批量下载
   - 开启后，访客可以批量下载已选照片

**注意**：如果选择了模板，批量下载设置会继承模板的配置，不会显示此开关。

#### 2. 为现有相册设置

1. 进入相册详情页
2. 点击「设置」按钮
3. 找到「允许批量下载」选项
4. 点击开关按钮开启或关闭
5. 点击「保存」

### 访客使用

1. 打开相册页面
2. 选择想要下载的照片（点击照片上的选择按钮）
3. 在相册顶部会显示「已选 X 张」和「下载已选」按钮
4. 点击「下载已选」按钮
5. 系统会逐个下载选中的照片

**注意**：
- 批量下载功能必须在相册设置中开启才能使用
- 只能下载已选中的照片
- 下载的是原图（无水印版本，如果相册允许下载原图）

---

## 🔧 技术说明

### 风格预设工作原理

1. **前端预览**：使用 CSS `filter` 属性实时预览效果
2. **后端处理**：使用 Sharp.js 库应用实际的图像调整
3. **处理流程**：
   - 照片上传时，如果相册有风格设置，自动应用
   - 更改风格后，需要重新处理现有照片
   - 处理后的照片会替换预览图

### 批量下载工作原理

1. **权限检查**：检查相册的 `allow_download` 和 `allow_batch_download` 设置
2. **生成链接**：通过 Worker API 为每张照片生成临时的 presigned URL（5分钟有效期）
3. **下载方式**：逐个触发浏览器下载

---

## ❓ 常见问题

### Q: 更改风格后，旧照片没有变化？
A: 需要重新处理照片。在更改风格设置时，系统会提示是否重新处理，点击「是」即可。

### Q: 批量下载按钮不显示？
A: 检查两点：
1. 相册设置中「允许下载」是否开启
2. 相册设置中「允许批量下载」是否开启

### Q: 可以同时应用多个风格吗？
A: 不可以，每个相册只能选择一个风格预设。如果需要不同的风格，可以创建多个相册。

### Q: 风格会影响原图吗？
A: 不会。风格只应用于预览图和处理后的图片，原图保持不变。

### Q: 如何移除风格？
A: 在相册设置中，展开风格选择器，选择「无风格」选项即可。

---

## 📝 最佳实践

1. **创建相册前规划**：根据拍摄主题选择合适的风格预设
2. **测试预览**：使用风格选择器的预览功能，确保效果符合预期
3. **批量下载权限**：根据相册用途决定是否开启批量下载
4. **重新处理时机**：在照片上传完成后再更改风格，避免重复处理

---

## 🎨 风格预设参数说明

每个预设包含以下参数调整：
- **亮度（Brightness）**：调整整体明暗
- **对比度（Contrast）**：调整明暗对比
- **饱和度（Saturation）**：调整色彩鲜艳度
- **色相（Hue）**：调整色彩倾向
- **Gamma**：调整中间调
- **色调（Tint）**：调整冷暖色调

这些参数经过精心调校，确保效果自然、统一。
