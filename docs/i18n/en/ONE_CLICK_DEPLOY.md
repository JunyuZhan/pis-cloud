# PIS One-Click Deployment to Public Server

> Automated script to quickly deploy PIS to a public server

## üìã Prerequisites

### Server Requirements

- **OS**: Ubuntu 20.04+ / Debian 11+ / CentOS 7+ / Other Linux distributions
- **Specs**: At least 2 cores 2GB RAM, recommended 4 cores 4GB+
- **Network**: Public IP, ports 19000, 19001, 16379, 3001 open (or configured via firewall)
- **SSH Access**: Ensure SSH access to the server

### Local Requirements

- **SSH Client**: SSH key or password access configured
- **Project Files**: PIS project cloned locally

## üöÄ Quick Start

### Method 1: Deploy Directly from GitHub (Recommended)

**No need to clone code locally - pull directly from GitHub on the server!**

```bash
# Run from anywhere (no need to be in project directory)
bash <(curl -sSL https://raw.githubusercontent.com/junyuzhan/pis/main/scripts/deploy-to-server.sh)

# Or clone the script first
git clone https://github.com/junyuzhan/pis.git
cd pis
bash scripts/deploy-to-server.sh
```

The script will guide you through:
1. Entering server IP and SSH username
2. **Choosing code source**: Clone from GitHub (recommended) or upload locally
3. Configuring Supabase credentials
4. Configuring MinIO credentials (optional, auto-generated by default)
5. Auto-installing Docker, Docker Compose, and Git
6. Cloning latest code from GitHub
7. Starting services
8. Optional Nginx reverse proxy and SSL configuration

### Method 2: Command Line Arguments

```bash
# Specify server IP, username, GitHub repo, and branch
bash scripts/deploy-to-server.sh <server-ip> <ssh-user> [github-repo] [branch]

# Examples (using default repo)
bash scripts/deploy-to-server.sh 192.168.1.100 root

# Examples (specifying custom repo and branch)
bash scripts/deploy-to-server.sh 192.168.1.100 root https://github.com/your-username/pis.git main
```

### Method 3: Local Upload Deployment

If you've modified code locally, choose local upload:

```bash
# Run from project root directory
bash scripts/deploy-to-server.sh

# Select "2) Upload from local"
```

## üìù Deployment Process

### 1. Prepare Supabase Configuration

Before running the deployment script, prepare:

- **Supabase Project URL**: `https://xxxxx.supabase.co`
- **Supabase Service Role Key**: Get from Supabase Dashboard ‚Üí Settings ‚Üí API

> üí° **Tip**: Make sure you've run database migrations in Supabase (see [Deployment Guide](./DEPLOYMENT.md#supabase-configuration))

### 2. Run Deployment Script

```bash
cd /path/to/pis
bash scripts/deploy-to-server.sh
```

### 3. Enter Information as Prompted

The script will ask for:

```
Enter server IP address: 192.168.1.100
Enter SSH username [default: root]: root
Supabase Project URL: https://xxxxx.supabase.co
Supabase Service Role Key: eyJhbGciOiJIUzI1NiIs...
MinIO Access Key [default: auto-generate]: [Press Enter to auto-generate]
MinIO Secret Key [default: auto-generate]: [Press Enter to auto-generate]
Configure Nginx reverse proxy? [y/N]: y
Enter media domain (e.g., media.example.com): media.example.com
Select SSL configuration method [1-3]: 1
```

### 4. Wait for Deployment to Complete

The script will automatically:

- ‚úÖ Check and install Docker
- ‚úÖ Check and install Docker Compose
- ‚úÖ Check port availability
- ‚úÖ Create deployment directory structure
- ‚úÖ Upload project files
- ‚úÖ Configure environment variables
- ‚úÖ Build Worker image
- ‚úÖ Start all services
- ‚úÖ Verify service health
- ‚úÖ Configure Nginx (optional)
- ‚úÖ Configure SSL certificate (optional)

## üîß Post-Deployment Configuration

### 1. Access MinIO Console

After deployment, access MinIO console at:

```
http://your-server-ip:19001
```

Login with the Access Key and Secret Key configured during deployment.

### 2. Configure Frontend Environment Variables

Configure the following environment variables in Vercel or other frontend hosting platforms:

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Application Configuration
NEXT_PUBLIC_APP_URL=https://yourdomain.com

# Media Storage Configuration (if Nginx configured)
NEXT_PUBLIC_MEDIA_URL=https://media.yourdomain.com/pis-photos

# Or use IP directly (not recommended for production)
NEXT_PUBLIC_MEDIA_URL=http://your-server-ip:19000/pis-photos

# Worker Configuration
NEXT_PUBLIC_WORKER_URL=http://your-server-ip:3001
```

### 3. Deploy Frontend to Vercel

Refer to [Deployment Guide](./DEPLOYMENT.md#vercel-deployment) to deploy frontend to Vercel.

## üõ†Ô∏è Common Operations

### View Service Status

```bash
ssh user@server 'cd /opt/pis/docker && docker-compose ps'
```

### View Logs

```bash
# View all service logs
ssh user@server 'cd /opt/pis/docker && docker-compose logs -f'

# View specific service logs
ssh user@server 'cd /opt/pis/docker && docker-compose logs -f worker'
ssh user@server 'cd /opt/pis/docker && docker-compose logs -f minio'
```

### Restart Services

```bash
# Restart all services
ssh user@server 'cd /opt/pis/docker && docker-compose restart'

# Restart specific service
ssh user@server 'cd /opt/pis/docker && docker-compose restart worker'
```

### Stop Services

```bash
ssh user@server 'cd /opt/pis/docker && docker-compose down'
```

### Update Worker Code

```bash
# 1. After modifying code locally, re-upload
scp -r services/worker/src user@server:/opt/pis/services/worker/

# 2. Rebuild and start on server
ssh user@server 'cd /opt/pis/docker && docker-compose build worker && docker-compose up -d worker'
```

## üîí Security Recommendations

### 1. Change Default Ports (Optional)

If default ports are occupied or you need more security, modify port mappings in `docker-compose.yml`:

```yaml
ports:
  - "custom-port:9000"  # MinIO API
  - "custom-port:9001"  # MinIO Console
```

### 2. Configure Firewall

```bash
# Ubuntu/Debian
sudo ufw allow 19000/tcp
sudo ufw allow 19001/tcp
sudo ufw allow 3001/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=19000/tcp
sudo firewall-cmd --permanent --add-port=19001/tcp
sudo firewall-cmd --permanent --add-port=3001/tcp
sudo firewall-cmd --reload
```

### 3. Use Strong Passwords

The deployment script auto-generates random passwords. Please save them securely. To modify:

```bash
ssh user@server
cd /opt/pis
nano .env  # Modify MINIO_ACCESS_KEY and MINIO_SECRET_KEY
cd docker
docker-compose restart
```

### 4. Restrict MinIO Console Access

For production, bind MinIO Console port (19001) to localhost only, access via SSH tunnel:

```yaml
# Modify docker-compose.yml
ports:
  - "127.0.0.1:19001:9001"  # Localhost only
```

Then access via SSH tunnel:

```bash
ssh -L 19001:localhost:19001 user@server
# Then access http://localhost:19001 in browser
```

## ‚ùì FAQ

### Q: Deployment failed with "Docker not installed"

**A**: The script will attempt to install Docker automatically. If it fails, install manually:

```bash
curl -fsSL https://get.docker.com | sh
```

### Q: Ports are occupied, what to do?

**A**: The script checks port availability. If ports are occupied, you can:

1. Stop services using those ports
2. Modify port mappings in `docker-compose.yml`

### Q: Worker build failed

**A**: Possible causes:

1. **Network issues**: Check if server can access Docker Hub
2. **Insufficient memory**: Worker build requires enough memory, recommend at least 2GB
3. **Insufficient disk space**: Check disk space `df -h`

Solutions:

```bash
# View build logs
ssh user@server 'cd /opt/pis/docker && docker-compose build worker'

# Clean Docker cache
ssh user@server 'docker system prune -a'
```

### Q: How to update to latest version?

**A**: 

If code was cloned from GitHub, updating is very simple:

```bash
# Pull latest code directly on server and restart services
ssh user@server 'cd /opt/pis && git pull && cd docker && docker-compose build worker && docker-compose up -d'
```

Or re-run the deployment script (will backup old version):

```bash
bash scripts/deploy-to-server.sh <server-ip> <username>
```

If using local upload method:

```bash
# 1. Pull latest code locally
git pull

# 2. Re-run deployment script (will overwrite existing files)
bash scripts/deploy-to-server.sh <server-ip> <username>

# 3. Or manually update specific files
scp docker/docker-compose.yml user@server:/opt/pis/docker/
scp -r services/worker/src user@server:/opt/pis/services/worker/
ssh user@server 'cd /opt/pis/docker && docker-compose build worker && docker-compose up -d'
```

### Q: Can I use a private repository?

**A**: Yes! When prompted for GitHub repository address, enter your private repository:

```
GitHub repository: https://github.com/your-username/your-private-repo.git
```

If the repository requires authentication, ensure SSH keys are configured on the server or use HTTPS authentication:

```bash
# Configure Git credentials on server
ssh user@server 'git config --global credential.helper store'
# Then manually clone once to save credentials
```

### Q: How to backup data?

**A**: 

```bash
# Backup MinIO data
ssh user@server 'docker run --rm -v pis_minio_data:/data -v $(pwd):/backup alpine tar czf /backup/minio-backup-$(date +%Y%m%d).tar.gz -C /data .'

# Backup Redis data
ssh user@server 'docker exec pis-redis redis-cli SAVE && docker cp pis-redis:/data/dump.rdb ./redis-backup-$(date +%Y%m%d).rdb'
```

### Q: Services won't start

**A**: Check steps:

1. View service logs: `docker-compose logs`
2. Check environment variables: `cat /opt/pis/.env`
3. Check port occupancy: `ss -tuln | grep -E ":(19000|19001|16379|3001)"`
4. Check Docker service: `systemctl status docker`

## üìö Related Documentation

- [Complete Deployment Guide](./DEPLOYMENT.md) - Detailed deployment steps and configuration
- [Storage Configuration](./STORAGE_CONFIG.md) - MinIO/OSS/COS/S3 configuration guide
- [Database Configuration](./DATABASE_CONFIG.md) - Supabase/PostgreSQL/MySQL configuration guide
- [Security Guide](../../SECURITY.md) - Security best practices

## üÜò Get Help

If you encounter issues:

1. Check the FAQ section in this document
2. Search [GitHub Issues](https://github.com/junyuzhan/pis/issues)
3. Submit a new Issue with:
   - Error logs
   - Server environment information
   - Deployment steps

---

**Happy Deploying!** üéâ
