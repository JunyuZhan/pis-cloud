# ç™»å½•åŠŸèƒ½å®‰å…¨å®¡è®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸ**: 2026-01-26  
**å®¡è®¡èŒƒå›´**: ç®¡ç†å‘˜ç™»å½•åŠŸèƒ½é˜²æ’åº“æ”»å‡»èƒ½åŠ›

---

## ğŸ” å‘ç°çš„å®‰å…¨é—®é¢˜

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1. **é€Ÿç‡é™åˆ¶å¯è¢«ç»•è¿‡** âš ï¸ å·²ä¿®å¤

**é—®é¢˜æè¿°**:
- å®¢æˆ·ç«¯å…ˆè°ƒç”¨é€Ÿç‡é™åˆ¶æ£€æŸ¥ APIï¼Œç„¶åç›´æ¥è°ƒç”¨ Supabase Auth
- æ”»å‡»è€…å¯ä»¥ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ï¼Œè·³è¿‡é€Ÿç‡é™åˆ¶æ£€æŸ¥
- æ”»å‡»è€…å¯ä»¥ç›´æ¥è°ƒç”¨ Supabase Auth APIï¼Œå®Œå…¨ç»•è¿‡é€Ÿç‡é™åˆ¶

**å½±å“**:
- æ”»å‡»è€…å¯ä»¥æ— é™åˆ¶åœ°å°è¯•ç™»å½•
- é€Ÿç‡é™åˆ¶å®Œå…¨å¤±æ•ˆ

**ä¿®å¤æ–¹æ¡ˆ**:
- âœ… å°†ç™»å½•é€»è¾‘å®Œå…¨ç§»åˆ°æœåŠ¡ç«¯ API (`/api/auth/login`)
- âœ… å®¢æˆ·ç«¯åªèƒ½è°ƒç”¨æœåŠ¡ç«¯ APIï¼Œæ— æ³•ç›´æ¥è°ƒç”¨ Supabase Auth
- âœ… æœåŠ¡ç«¯ API åœ¨æ‰§è¡Œç™»å½•å‰å…ˆæ£€æŸ¥é€Ÿç‡é™åˆ¶

**ä»£ç å˜æ›´**:
- `apps/web/src/app/api/auth/login/route.ts` - å®Œæ•´çš„æœåŠ¡ç«¯ç™»å½•é€»è¾‘
- `apps/web/src/app/admin/login/page.tsx` - å®¢æˆ·ç«¯åªè°ƒç”¨æœåŠ¡ç«¯ API

---

#### 2. **IP åœ°å€è·å–ä¸å¯é ** âš ï¸ å·²ä¿®å¤

**é—®é¢˜æè¿°**:
- IP åœ°å€æå–é€»è¾‘ç®€å•ï¼Œå¯èƒ½è·å–ä¸åˆ°çœŸå® IP
- æ²¡æœ‰è€ƒè™‘ Cloudflare ç­‰ CDN çš„æƒ…å†µ
- IP å¯èƒ½è¢«ä¼ªé€ 

**å½±å“**:
- é€Ÿç‡é™åˆ¶å¯èƒ½å¤±æ•ˆ
- æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¼ªé€  IP ç»•è¿‡é™åˆ¶

**ä¿®å¤æ–¹æ¡ˆ**:
- âœ… æ”¹è¿› IP æå–é€»è¾‘ï¼Œä¼˜å…ˆä½¿ç”¨ `cf-connecting-ip`ï¼ˆCloudflareï¼‰
- âœ… ç„¶åä½¿ç”¨ `x-forwarded-for` çš„ç¬¬ä¸€ä¸ª IP
- âœ… æœ€åä½¿ç”¨ `x-real-ip` æˆ– `request.ip`

**ä»£ç å˜æ›´**:
```typescript
// æ”¹è¿›çš„ IP æå–é€»è¾‘
const cfConnectingIp = request.headers.get('cf-connecting-ip')
const forwardedFor = request.headers.get('x-forwarded-for')
const realIp = request.headers.get('x-real-ip')

let ip = 'unknown'
if (cfConnectingIp) {
  ip = cfConnectingIp
} else if (forwardedFor) {
  ip = forwardedFor.split(',')[0].trim()
} else if (realIp) {
  ip = realIp
} else if (request.ip) {
  ip = request.ip
}
```

---

#### 3. **é”™è¯¯ä¿¡æ¯æ³„éœ²** âš ï¸ å·²ä¿®å¤

**é—®é¢˜æè¿°**:
- é”™è¯¯æ¶ˆæ¯æš´éœ²å…·ä½“é”™è¯¯åŸå› ï¼ˆå¦‚"ç”¨æˆ·ä¸å­˜åœ¨"ã€"é‚®ç®±æœªéªŒè¯"ï¼‰
- æ”»å‡»è€…å¯ä»¥é€šè¿‡é”™è¯¯æ¶ˆæ¯æšä¸¾æœ‰æ•ˆé‚®ç®±
- æ³„éœ²äº†ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯

**å½±å“**:
- ç”¨æˆ·æšä¸¾æ”»å‡»
- ä¿¡æ¯æ³„éœ²

**ä¿®å¤æ–¹æ¡ˆ**:
- âœ… ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ï¼š"é‚®ç®±æˆ–å¯†ç é”™è¯¯"
- âœ… æ— è®ºä»€ä¹ˆé”™è¯¯ï¼ˆå¯†ç é”™è¯¯ã€ç”¨æˆ·ä¸å­˜åœ¨ã€é‚®ç®±æœªéªŒè¯ï¼‰ï¼Œéƒ½è¿”å›ç›¸åŒæ¶ˆæ¯
- âœ… é˜²æ­¢ç”¨æˆ·æšä¸¾å’Œä¿¡æ¯æ³„éœ²

**ä»£ç å˜æ›´**:
```typescript
// ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯
if (error) {
  return NextResponse.json(
    {
      error: {
        code: 'AUTH_ERROR',
        message: 'é‚®ç®±æˆ–å¯†ç é”™è¯¯', // ç»Ÿä¸€æ¶ˆæ¯
      },
    },
    { status: 401 }
  )
}
```

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 4. **ç¼ºå°‘åŸºäºé‚®ç®±çš„é€Ÿç‡é™åˆ¶** âš ï¸ å·²ä¿®å¤

**é—®é¢˜æè¿°**:
- åªæœ‰åŸºäº IP çš„é€Ÿç‡é™åˆ¶
- æ”»å‡»è€…å¯ä»¥é’ˆå¯¹ç‰¹å®šé‚®ç®±è¿›è¡Œæš´åŠ›ç ´è§£
- åˆ†å¸ƒå¼æ”»å‡»å¯ä»¥ç»•è¿‡ IP é™åˆ¶

**å½±å“**:
- é’ˆå¯¹ç‰¹å®šè´¦æˆ·çš„æš´åŠ›ç ´è§£æ”»å‡»
- åˆ†å¸ƒå¼æ”»å‡»å¯èƒ½ç»•è¿‡é™åˆ¶

**ä¿®å¤æ–¹æ¡ˆ**:
- âœ… æ·»åŠ åŸºäºé‚®ç®±çš„é€Ÿç‡é™åˆ¶ï¼ˆ3 æ¬¡/åˆ†é’Ÿï¼‰
- âœ… åŒé‡é™åˆ¶ï¼šIP + é‚®ç®±
- âœ… é˜²æ­¢é’ˆå¯¹ç‰¹å®šè´¦æˆ·çš„æ”»å‡»

**ä»£ç å˜æ›´**:
```typescript
// åŒé‡é€Ÿç‡é™åˆ¶
const ipRateLimit = checkRateLimit(`login:ip:${ip}`, 5, 60 * 1000)
const emailRateLimit = checkRateLimit(`login:email:${normalizedEmail}`, 3, 60 * 1000)

if (!ipRateLimit.allowed || !emailRateLimit.allowed) {
  return 429 // Rate limit exceeded
}
```

---

#### 5. **å†…å­˜é€Ÿç‡é™åˆ¶å¯èƒ½æ³„æ¼** âš ï¸ å·²ä¿®å¤

**é—®é¢˜æè¿°**:
- å†…å­˜å­˜å‚¨å¯èƒ½æ— é™å¢é•¿
- æ²¡æœ‰æ¸…ç†æœºåˆ¶å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
- æ”»å‡»è€…å¯èƒ½é€šè¿‡å¤§é‡è¯·æ±‚è€—å°½å†…å­˜

**å½±å“**:
- å†…å­˜æ³„æ¼
- DoS æ”»å‡»ï¼ˆå†…å­˜è€—å°½ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
- âœ… æ·»åŠ æœ€å¤§å­˜å‚¨é™åˆ¶ï¼ˆ10,000 æ¡è®°å½•ï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
- âœ… å½“å­˜å‚¨è¿‡å¤§æ—¶ï¼Œæ¸…ç†æœ€æ—§çš„ 10% è®°å½•
- âœ… å®šæœŸæ¸…ç†ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰

**ä»£ç å˜æ›´**:
```typescript
const MAX_STORE_SIZE = 10000

// æ¯æ¬¡æ£€æŸ¥æ—¶æ¸…ç†è¿‡æœŸè®°å½•
cleanupExpiredRecords()

// å¦‚æœå­˜å‚¨è¿‡å¤§ï¼Œæ¸…ç†æœ€æ—§çš„è®°å½•
if (Object.keys(store).length >= MAX_STORE_SIZE) {
  cleanupOldestRecords()
}
```

---

## âœ… å·²å®æ–½çš„å®‰å…¨æªæ–½

### 1. æœåŠ¡ç«¯ç™»å½•éªŒè¯
- âœ… ç™»å½•é€»è¾‘å®Œå…¨åœ¨æœåŠ¡ç«¯æ‰§è¡Œ
- âœ… å®¢æˆ·ç«¯æ— æ³•ç»•è¿‡é€Ÿç‡é™åˆ¶
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†

### 2. åŒé‡é€Ÿç‡é™åˆ¶
- âœ… åŸºäº IPï¼š5 æ¬¡/åˆ†é’Ÿ
- âœ… åŸºäºé‚®ç®±ï¼š3 æ¬¡/åˆ†é’Ÿ
- âœ… é˜²æ­¢å• IP å’Œåˆ†å¸ƒå¼æ”»å‡»

### 3. æ”¹è¿›çš„ IP æå–
- âœ… æ”¯æŒ Cloudflare (`cf-connecting-ip`)
- âœ… æ”¯æŒä»£ç†æœåŠ¡å™¨ (`x-forwarded-for`)
- âœ… é™çº§ç­–ç•¥ï¼ˆå¤šç§ IP æ¥æºï¼‰

### 4. ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯
- âœ… ä¸æš´éœ²å…·ä½“é”™è¯¯åŸå› 
- âœ… é˜²æ­¢ç”¨æˆ·æšä¸¾
- âœ… é˜²æ­¢ä¿¡æ¯æ³„éœ²

### 5. å†…å­˜ç®¡ç†
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
- âœ… é™åˆ¶æœ€å¤§å­˜å‚¨å¤§å°
- âœ… é˜²æ­¢å†…å­˜æ³„æ¼å’Œ DoS æ”»å‡»

---

## ğŸ“Š å®‰å…¨æµ‹è¯•å»ºè®®

### 1. é€Ÿç‡é™åˆ¶æµ‹è¯•
```bash
# æµ‹è¯• IP é€Ÿç‡é™åˆ¶ï¼ˆåº”è¯¥åœ¨ç¬¬ 6 æ¬¡è¯·æ±‚æ—¶è¢«é˜»æ­¢ï¼‰
for i in {1..10}; do
  curl -X POST http://localhost:3000/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"test@example.com","password":"wrong"}'
  sleep 1
done
```

### 2. é‚®ç®±é€Ÿç‡é™åˆ¶æµ‹è¯•
```bash
# æµ‹è¯•é‚®ç®±é€Ÿç‡é™åˆ¶ï¼ˆåº”è¯¥åœ¨ç¬¬ 4 æ¬¡è¯·æ±‚æ—¶è¢«é˜»æ­¢ï¼‰
for i in {1..5}; do
  curl -X POST http://localhost:3000/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"target@example.com","password":"wrong"}'
  sleep 1
done
```

### 3. é”™è¯¯æ¶ˆæ¯æµ‹è¯•
```bash
# æµ‹è¯•é”™è¯¯æ¶ˆæ¯æ˜¯å¦ç»Ÿä¸€
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"nonexistent@example.com","password":"wrong"}'
# åº”è¯¥è¿”å›ï¼š"é‚®ç®±æˆ–å¯†ç é”™è¯¯"ï¼ˆä¸æ˜¯"ç”¨æˆ·ä¸å­˜åœ¨"ï¼‰
```

### 4. ç»•è¿‡æµ‹è¯•
```bash
# å°è¯•ç›´æ¥è°ƒç”¨ Supabase Authï¼ˆåº”è¯¥å¤±è´¥ï¼Œå› ä¸ºå®¢æˆ·ç«¯æ— æ³•ç›´æ¥è°ƒç”¨ï¼‰
# åªèƒ½é€šè¿‡æœåŠ¡ç«¯ API ç™»å½•
```

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶
```typescript
// ä½¿ç”¨ Upstash Redis æˆ–ç±»ä¼¼æœåŠ¡
import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(5, '1 m'),
})
```

### 2. æ·»åŠ è´¦æˆ·é”å®šæœºåˆ¶
- è¿ç»­å¤±è´¥ 5 æ¬¡åé”å®šè´¦æˆ· 15 åˆ†é’Ÿ
- è®°å½•å¤±è´¥å°è¯•æ—¥å¿—
- å‘é€å®‰å…¨é€šçŸ¥é‚®ä»¶

### 3. æ·»åŠ éªŒè¯ç ï¼ˆCAPTCHAï¼‰
- å¤±è´¥ 3 æ¬¡åæ˜¾ç¤ºéªŒè¯ç 
- ä½¿ç”¨ reCAPTCHA æˆ– hCaptcha
- é˜²æ­¢è‡ªåŠ¨åŒ–æ”»å‡»

### 4. ç›‘æ§å’Œå‘Šè­¦
- ç›‘æ§å¼‚å¸¸ç™»å½•å°è¯•
- è®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼ˆå¦‚ 10 æ¬¡å¤±è´¥/åˆ†é’Ÿï¼‰
- è®°å½•å®‰å…¨äº‹ä»¶æ—¥å¿—

### 5. å¯ç”¨åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰
- ä½¿ç”¨ Supabase Auth çš„ 2FA åŠŸèƒ½
- æé«˜è´¦æˆ·å®‰å…¨æ€§
- é˜²æ­¢å¯†ç æ³„éœ²åçš„è´¦æˆ·è¢«ç›—

---

## ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•

- [x] ç™»å½•é€»è¾‘åœ¨æœåŠ¡ç«¯æ‰§è¡Œ
- [x] é€Ÿç‡é™åˆ¶æ— æ³•ç»•è¿‡
- [x] IP åœ°å€æå–å¯é 
- [x] é”™è¯¯æ¶ˆæ¯ç»Ÿä¸€
- [x] åŒé‡é€Ÿç‡é™åˆ¶ï¼ˆIP + é‚®ç®±ï¼‰
- [x] å†…å­˜ç®¡ç†å®Œå–„
- [ ] Redis åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] è´¦æˆ·é”å®šæœºåˆ¶
- [ ] éªŒè¯ç ä¿æŠ¤
- [ ] ç™»å½•å°è¯•æ—¥å¿—
- [ ] å¼‚å¸¸è¡Œä¸ºç›‘æ§
- [ ] åŒå› ç´ è®¤è¯

---

## ğŸ“š å‚è€ƒèµ„æº

- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [OWASP Brute Force Attack](https://owasp.org/www-community/attacks/Brute_force_attack)
- [Supabase Auth Rate Limits](https://supabase.com/docs/guides/auth/rate-limits)
- [Next.js Security Best Practices](https://nextjs.org/docs/app/building-your-application/configuring/security-headers)

---

**æœ€åæ›´æ–°**: 2026-01-26
