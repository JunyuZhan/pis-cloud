# é¢„è§ˆå›¾æ ‡å‡†é…ç½®è¯´æ˜Ž

> æ›´æ–°æ—¶é—´: 2026-01-26

## ðŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜Žå¦‚ä½•é…ç½®é¢„è§ˆå›¾å’Œç¼©ç•¥å›¾çš„æ ‡å‡†å°ºå¯¸ï¼Œä»¥åŠå¦‚ä½•å¤„ç†é¢„è§ˆå›¾æ ‡å‡†å˜æ›´åŽçš„å…¼å®¹æ€§é—®é¢˜ã€‚

---

## âš™ï¸ é…ç½®é¢„è§ˆå›¾æ ‡å‡†

### çŽ¯å¢ƒå˜é‡é…ç½®

é¢„è§ˆå›¾å’Œç¼©ç•¥å›¾çš„å°ºå¯¸å¯ä»¥é€šè¿‡çŽ¯å¢ƒå˜é‡é…ç½®ï¼š

```bash
# é¢„è§ˆå›¾æœ€å¤§å°ºå¯¸ï¼ˆåƒç´ ï¼‰ï¼Œé»˜è®¤ 1920px
PREVIEW_MAX_SIZE=1920

# ç¼©ç•¥å›¾æœ€å¤§å°ºå¯¸ï¼ˆåƒç´ ï¼‰ï¼Œé»˜è®¤ 400px
THUMB_MAX_SIZE=400
```

### é…ç½®ä½ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `.env.local` æ–‡ä»¶ä¸­æ·»åŠ ä¸Šè¿°é…ç½®ï¼š

```bash
# å›¾ç‰‡å¤„ç†æ ‡å‡†é…ç½®ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼å‘åŽå…¼å®¹ï¼‰
# é¢„è§ˆå›¾æœ€å¤§å°ºå¯¸ï¼ˆåƒç´ ï¼‰ï¼Œé»˜è®¤ 1920px
PREVIEW_MAX_SIZE=1920

# ç¼©ç•¥å›¾æœ€å¤§å°ºå¯¸ï¼ˆåƒç´ ï¼‰ï¼Œé»˜è®¤ 400px
THUMB_MAX_SIZE=400
```

### ç”Ÿæ•ˆæ–¹å¼

1. **æ–°ä¸Šä¼ çš„ç…§ç‰‡**ï¼šç«‹å³ä½¿ç”¨æ–°çš„é¢„è§ˆå›¾æ ‡å‡†
2. **å·²ä¸Šä¼ çš„ç…§ç‰‡**ï¼šä¿æŒåŽŸæœ‰é¢„è§ˆå›¾ï¼Œä¸ä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆ

---

## ðŸ”„ é¢„è§ˆå›¾æ ‡å‡†å˜æ›´åŽçš„å¤„ç†

**é‡è¦è¯´æ˜Ž**ï¼šç³»ç»Ÿå·²å®žçŽ°è‡ªåŠ¨å‘åŽå…¼å®¹æœºåˆ¶ï¼Œ**ä¿®æ”¹é¢„è§ˆå›¾æ ‡å‡†åŽï¼Œæ—§å›¾ç‰‡ä¼šè‡ªåŠ¨é™çº§æ˜¾ç¤ºï¼Œæ— éœ€ä»»ä½•æ“ä½œå³å¯æ­£å¸¸æ˜¾ç¤º**ã€‚

å½“æ‚¨ä¿®æ”¹äº†é¢„è§ˆå›¾æ ‡å‡†ï¼ˆä¾‹å¦‚ä»Ž 1920px æ”¹ä¸º 2560pxï¼‰åŽï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼š

### æ–¹å¼ 1ï¼šå‘åŽå…¼å®¹ï¼ˆé»˜è®¤ï¼ŒæŽ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… **æ— éœ€é‡æ–°éƒ¨ç½²æˆ–é‡å¯**ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†
- âœ… æ— éœ€é‡æ–°å¤„ç†ï¼ŒèŠ‚çœèµ„æº
- âœ… æ—§å›¾ç‰‡ä»èƒ½æ­£å¸¸æ˜¾ç¤ºï¼ˆè‡ªåŠ¨é™çº§åˆ°ç¼©ç•¥å›¾æˆ–åŽŸå›¾ï¼‰
- âœ… æ–°ä¸Šä¼ çš„å›¾ç‰‡ä½¿ç”¨æ–°æ ‡å‡†

**å·¥ä½œåŽŸç†**ï¼š
- å‰ç«¯ä¼šè‡ªåŠ¨é™çº§ï¼šå¦‚æžœé¢„è§ˆå›¾ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ç¼©ç•¥å›¾æˆ–åŽŸå›¾
- å›¾ç‰‡åŠ è½½ä¼˜å…ˆçº§ï¼š`preview_key` â†’ `thumb_key` â†’ `original_key`
- **å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥å¹²é¢„**

**é€‚ç”¨åœºæ™¯**ï¼š
- é¢„è§ˆå›¾æ ‡å‡†è°ƒæ•´ï¼ˆæ— è®ºå¤§å°ï¼‰
- ä¸éœ€è¦æ‰€æœ‰å›¾ç‰‡ç»Ÿä¸€æ ‡å‡†
- å¸Œæœ›èŠ‚çœå¤„ç†èµ„æºå’Œæ—¶é—´
- **å¤§å¤šæ•°åœºæ™¯æŽ¨èä½¿ç”¨æ­¤æ–¹å¼**

### æ–¹å¼ 2ï¼šé‡æ–°ç”Ÿæˆé¢„è§ˆå›¾ï¼ˆå¯é€‰ï¼‰

**ä»€ä¹ˆæ—¶å€™éœ€è¦**ï¼š
- å¸Œæœ›æ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ç»Ÿä¸€æ ‡å‡†
- éœ€è¦ç¡®ä¿æœ€ä½³æ˜¾ç¤ºæ•ˆæžœ
- é¢„è§ˆå›¾æ ‡å‡†å¤§å¹…è°ƒæ•´ï¼ˆå¦‚ 1920px â†’ 3840pxï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ç»Ÿä¸€æ ‡å‡†
- âœ… ç¡®ä¿æœ€ä½³æ˜¾ç¤ºæ•ˆæžœ

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦é‡æ–°å¤„ç†ï¼Œæ¶ˆè€—èµ„æº
- âš ï¸ å¤„ç†æ—¶é—´è¾ƒé•¿ï¼ˆå–å†³äºŽç…§ç‰‡æ•°é‡ï¼‰
- âš ï¸ **ä¸éœ€è¦ä¿®æ”¹çŽ¯å¢ƒå˜é‡æˆ–é‡å¯ worker**

**é‡è¦**ï¼šé‡æ–°ç”Ÿæˆé¢„è§ˆå›¾åŠŸèƒ½**ä¸éœ€è¦ä¿®æ”¹çŽ¯å¢ƒå˜é‡æˆ–é‡å¯ worker**ï¼Œåªéœ€è¦ï¼š
1. ä¿æŒå½“å‰çŽ¯å¢ƒå˜é‡é…ç½®ï¼ˆæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
2. åœ¨ç®¡ç†ç•Œé¢ä½¿ç”¨"é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾"åŠŸèƒ½
3. ç³»ç»Ÿä¼šä½¿ç”¨å½“å‰ worker é…ç½®çš„æ ‡å‡†é‡æ–°å¤„ç†

**æ“ä½œæ­¥éª¤**ï¼š

#### 2.1 æ‰¹é‡é‡æ–°ç”Ÿæˆï¼ˆé€‰ä¸­ç…§ç‰‡ï¼‰

1. åœ¨ç›¸å†Œè¯¦æƒ…é¡µï¼Œç‚¹å‡»ã€Œé€‰æ‹©ã€æŒ‰é’®
2. é€‰æ‹©éœ€è¦é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾çš„ç…§ç‰‡
3. ç‚¹å‡»ã€Œé‡æ–°ç”Ÿæˆé¢„è§ˆå›¾ã€æŒ‰é’®
4. ç¡®è®¤æ“ä½œ

#### 2.2 é‡æ–°ç”Ÿæˆæ•´ä¸ªç›¸å†Œ

1. åœ¨ç›¸å†Œè¯¦æƒ…é¡µï¼Œç‚¹å‡»ã€Œé‡æ–°ç”Ÿæˆé¢„è§ˆå›¾ã€æŒ‰é’®ï¼ˆæœªé€‰æ‹©ç…§ç‰‡æ—¶ï¼‰
2. ç¡®è®¤æ“ä½œ
3. ç³»ç»Ÿä¼šå°†æ•´ä¸ªç›¸å†Œçš„æ‰€æœ‰ç…§ç‰‡åŠ å…¥å¤„ç†é˜Ÿåˆ—

**å¤„ç†æµç¨‹**ï¼š
1. ç…§ç‰‡çŠ¶æ€å˜ä¸º `pending`
2. Worker ä»Žå­˜å‚¨ä¸‹è½½åŽŸå›¾
3. ä½¿ç”¨æœ€æ–°çš„é¢„è§ˆå›¾æ ‡å‡†é‡æ–°å¤„ç†
4. ç”Ÿæˆæ–°çš„é¢„è§ˆå›¾å’Œç¼©ç•¥å›¾
5. ä¸Šä¼ åˆ°å­˜å‚¨å¹¶æ›´æ–°æ•°æ®åº“
6. ç…§ç‰‡çŠ¶æ€å˜ä¸º `completed`

**æ³¨æ„äº‹é¡¹**ï¼š
- å•æ¬¡æœ€å¤šé‡æ–°å¤„ç† 100 å¼ ç…§ç‰‡
- å¤„ç†è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ ååˆ†é’Ÿï¼ˆå–å†³äºŽç…§ç‰‡æ•°é‡å’Œå¤§å°ï¼‰
- å¤„ç†è¿‡ç¨‹ä¸­ç…§ç‰‡ä¼šæ˜¾ç¤ºä¸ºã€Œå¤„ç†ä¸­ã€çŠ¶æ€
- ç³»ç»Ÿä¼šè‡ªåŠ¨è½®è¯¢æ£€æŸ¥å¤„ç†çŠ¶æ€

---

## ðŸ› ï¸ æŠ€æœ¯å®žçŽ°

### Worker å¤„ç†é€»è¾‘

```typescript
// services/worker/src/processor.ts

// ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–é¢„è§ˆå›¾æ ‡å‡†ï¼Œé»˜è®¤ 1920px
const maxPreviewSize = parseInt(process.env.PREVIEW_MAX_SIZE || '1920', 10);

// ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–ç¼©ç•¥å›¾æ ‡å‡†ï¼Œé»˜è®¤ 400px
const thumbSize = parseInt(process.env.THUMB_MAX_SIZE || '400', 10);
```

### å‰ç«¯åŽå¤‡æœºåˆ¶

```typescript
// apps/web/src/components/album/masonry.tsx

// å›¾ç‰‡ key ä¼˜å…ˆçº§ï¼špreview_key -> thumb_key -> original_key
const imageKeys = [
  photo.preview_key,
  photo.thumb_key,
  photo.original_key,
].filter(Boolean) as string[]

// å¦‚æžœé¢„è§ˆå›¾åŠ è½½å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªåŽå¤‡æ–¹æ¡ˆ
const handleImageError = useCallback(() => {
  if (imageKeyIndex < imageKeys.length - 1) {
    setImageKeyIndex(imageKeyIndex + 1)
  }
}, [imageKeyIndex, imageKeys])
```

---

## ðŸ“Š æ€§èƒ½è€ƒè™‘

### é¢„è§ˆå›¾å°ºå¯¸å»ºè®®

| å°ºå¯¸ | é€‚ç”¨åœºæ™¯ | æ–‡ä»¶å¤§å°ï¼ˆä¼°ç®—ï¼‰ |
|------|---------|----------------|
| 1280px | ç§»åŠ¨ç«¯ä¼˜å…ˆï¼ŒèŠ‚çœå­˜å‚¨ | ~200-500KB |
| 1920px | å¹³è¡¡è´¨é‡å’Œå¤§å°ï¼ˆé»˜è®¤ï¼‰ | ~500KB-1MB |
| 2560px | é«˜è´¨é‡æ˜¾ç¤º | ~1-2MB |
| 3840px | 4K æ˜¾ç¤º | ~2-4MB |

### å­˜å‚¨æˆæœ¬

é¢„è§ˆå›¾å°ºå¯¸è¶Šå¤§ï¼Œå­˜å‚¨æˆæœ¬è¶Šé«˜ã€‚å»ºè®®æ ¹æ®å®žé™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„å°ºå¯¸ã€‚

---

## ðŸ” å¸¸è§é—®é¢˜

### Q: ä¿®æ”¹é¢„è§ˆå›¾æ ‡å‡†åŽï¼Œæ—§å›¾ç‰‡æ— æ³•æ˜¾ç¤ºï¼Ÿ

**A**: **ä¸ä¼šå‡ºçŽ°è¿™ç§æƒ…å†µ**ã€‚ç³»ç»Ÿå·²å®žçŽ°è‡ªåŠ¨å‘åŽå…¼å®¹ï¼š
- å‰ç«¯ä¼šè‡ªåŠ¨é™çº§ï¼šå¦‚æžœé¢„è§ˆå›¾ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ç¼©ç•¥å›¾æˆ–åŽŸå›¾
- **æ— éœ€ä»»ä½•æ“ä½œï¼Œæ—§å›¾ç‰‡ä¼šè‡ªåŠ¨æ­£å¸¸æ˜¾ç¤º**
- å¦‚æžœå¸Œæœ›æ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ç»Ÿä¸€æ ‡å‡†ï¼Œå¯ä»¥ä½¿ç”¨"é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾"åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

### Q: ä¿®æ”¹é¢„è§ˆå›¾æ ‡å‡†éœ€è¦é‡æ–°éƒ¨ç½² worker å—ï¼Ÿ

**A**: è¿™å–å†³äºŽæ‚¨çš„éœ€æ±‚ï¼š
- **å¦‚æžœåªæ˜¯æƒ³å¤„ç†æ—§å›¾ç‰‡**ï¼šä½¿ç”¨"é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾"åŠŸèƒ½å³å¯ï¼Œ**ä¸éœ€è¦ä¿®æ”¹çŽ¯å¢ƒå˜é‡æˆ–é‡å¯ worker**
- **å¦‚æžœæƒ³ä¿®æ”¹é¢„è§ˆå›¾æ ‡å‡†**ï¼ˆå¦‚ä»Ž 1920px æ”¹ä¸º 2560pxï¼‰ï¼šéœ€è¦ä¿®æ”¹çŽ¯å¢ƒå˜é‡å¹¶é‡å¯ workerï¼Œä½†æ—§å›¾ç‰‡ä¼šè‡ªåŠ¨é™çº§æ˜¾ç¤ºï¼Œæ— éœ€é‡æ–°å¤„ç†

### Q: å¦‚ä½•çŸ¥é“å“ªäº›ç…§ç‰‡éœ€è¦é‡æ–°ç”Ÿæˆï¼Ÿ

**A**: åœ¨ç›¸å†Œè¯¦æƒ…é¡µï¼Œç…§ç‰‡çŠ¶æ€ä¸º `completed` ä½†é¢„è§ˆå›¾ä½¿ç”¨æ—§æ ‡å‡†çš„ç…§ç‰‡ï¼Œå¯ä»¥é€šè¿‡æ‰¹é‡é‡æ–°ç”ŸæˆåŠŸèƒ½å¤„ç†ã€‚

### Q: é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾ä¼šå½±å“åŽŸå›¾å—ï¼Ÿ

**A**: ä¸ä¼šã€‚é‡æ–°ç”Ÿæˆåªå¤„ç†é¢„è§ˆå›¾å’Œç¼©ç•¥å›¾ï¼ŒåŽŸå›¾ä¿æŒä¸å˜ã€‚

### Q: å¯ä»¥åŒæ—¶ä¿®æ”¹é¢„è§ˆå›¾å’Œç¼©ç•¥å›¾æ ‡å‡†å—ï¼Ÿ

**A**: å¯ä»¥ã€‚åˆ†åˆ«è®¾ç½® `PREVIEW_MAX_SIZE` å’Œ `THUMB_MAX_SIZE` çŽ¯å¢ƒå˜é‡å³å¯ã€‚

### Q: ä¿®æ”¹æ ‡å‡†åŽéœ€è¦é‡å¯ Worker å—ï¼Ÿ

**A**: è¿™å–å†³äºŽæ‚¨çš„æ“ä½œï¼š
- **å¦‚æžœä½¿ç”¨"é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾"åŠŸèƒ½**ï¼šä¸éœ€è¦ä¿®æ”¹çŽ¯å¢ƒå˜é‡æˆ–é‡å¯ workerï¼Œç³»ç»Ÿä¼šä½¿ç”¨å½“å‰é…ç½®é‡æ–°å¤„ç†
- **å¦‚æžœæƒ³ä¿®æ”¹é¢„è§ˆå›¾æ ‡å‡†**ï¼ˆä¿®æ”¹ `PREVIEW_MAX_SIZE` çŽ¯å¢ƒå˜é‡ï¼‰ï¼šéœ€è¦é‡å¯ worker æ‰èƒ½ç”Ÿæ•ˆï¼Œä½†æ—§å›¾ç‰‡ä¼šè‡ªåŠ¨é™çº§æ˜¾ç¤ºï¼Œæ— éœ€é‡æ–°å¤„ç†

---

## ðŸ“ æœ€ä½³å®žè·µ

1. **é¦–æ¬¡éƒ¨ç½²**ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼ˆ1920pxï¼‰å³å¯æ»¡è¶³å¤§å¤šæ•°åœºæ™¯
2. **æ ‡å‡†è°ƒæ•´**ï¼š
   - **æŽ¨è**ï¼šä½¿ç”¨å‘åŽå…¼å®¹æ–¹å¼ï¼Œæ—§å›¾ç‰‡è‡ªåŠ¨é™çº§æ˜¾ç¤ºï¼Œæ— éœ€ä»»ä½•æ“ä½œ
   - **å¯é€‰**ï¼šå¦‚æžœå¸Œæœ›ç»Ÿä¸€æ ‡å‡†ï¼Œä½¿ç”¨"é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾"åŠŸèƒ½ï¼ˆä¸éœ€è¦ä¿®æ”¹çŽ¯å¢ƒå˜é‡ï¼‰
3. **ä¿®æ”¹é¢„è§ˆå›¾æ ‡å‡†**ï¼š
   - ä¿®æ”¹ `PREVIEW_MAX_SIZE` çŽ¯å¢ƒå˜é‡
   - é‡å¯ worker ä½¿æ–°æ ‡å‡†ç”Ÿæ•ˆ
   - æ—§å›¾ç‰‡ä¼šè‡ªåŠ¨é™çº§æ˜¾ç¤ºï¼Œæ–°ä¸Šä¼ çš„å›¾ç‰‡ä½¿ç”¨æ–°æ ‡å‡†
   - å¦‚éœ€ç»Ÿä¸€æ ‡å‡†ï¼Œå†ä½¿ç”¨"é‡æ–°ç”Ÿæˆé¢„è§ˆå›¾"åŠŸèƒ½
4. **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥é¢„è§ˆå›¾è´¨é‡ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´æ ‡å‡†
5. **å­˜å‚¨ç›‘æŽ§**ï¼šç›‘æŽ§å­˜å‚¨ä½¿ç”¨æƒ…å†µï¼Œé¿å…é¢„è§ˆå›¾è¿‡å¤§å¯¼è‡´æˆæœ¬å¢žåŠ 

## âš ï¸ é‡è¦æç¤º

**å‘åŽå…¼å®¹æ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ— éœ€ä»»ä½•æ“ä½œ**ï¼š
- âœ… ä¿®æ”¹é¢„è§ˆå›¾æ ‡å‡†åŽï¼Œæ—§å›¾ç‰‡ä¼šè‡ªåŠ¨é™çº§æ˜¾ç¤º
- âœ… ä¸éœ€è¦é‡æ–°éƒ¨ç½²æˆ–é‡å¯ï¼ˆé™¤éžä¿®æ”¹çŽ¯å¢ƒå˜é‡ï¼‰
- âœ… ä¸éœ€è¦é‡æ–°å¤„ç†æ—§å›¾ç‰‡ï¼ˆé™¤éžæ‚¨å¸Œæœ›ç»Ÿä¸€æ ‡å‡†ï¼‰

---

## ðŸ”— ç›¸å…³æ–‡æ¡£

- [Worker åŠŸèƒ½æ¸…å•](./WORKER_FEATURES.md) - Worker æœåŠ¡åŠŸèƒ½è¯´æ˜Ž
- [æ€§èƒ½ä¼˜åŒ–](./PERFORMANCE_OPTIMIZATION.md) - æ€§èƒ½ä¼˜åŒ–å»ºè®®
- [å‰ç«¯å›¾ç‰‡æ€§èƒ½ä¼˜åŒ–](./FRONTEND_IMAGE_PERFORMANCE_OPTIMIZATION.md) - å‰ç«¯å›¾ç‰‡ä¼˜åŒ–æ–¹æ¡ˆ
