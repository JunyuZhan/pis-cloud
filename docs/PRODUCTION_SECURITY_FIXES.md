# 安全修复部署指南

**创建日期**: 2026-01-26  
**状态**: 安全修复已完成

---

## ⚠️ 重要提示

所有安全修复在部署前都需要：
1. ✅ 先在测试环境验证
2. ✅ 保持向后兼容
3. ✅ 不影响现有功能
4. ✅ 逐步部署，监控异常

---

## ✅ 已完成的修复

### 1. 密码验证 API 速率限制 ✅

**修复内容**:
- 添加基于 IP 的速率限制（智能适配内网/公网部署）
  - 公网 IP：每分钟最多 10 次
  - 内网 IP：每分钟最多 30 次（适配内网部署，多个用户可能共享同一 IP）
  - unknown IP：跳过 IP 限制（主要依赖相册限制）
- 添加基于相册的速率限制：每分钟最多 5 次
- 使用与登录 API 相同的 IP 提取逻辑
- **智能检测内网 IP**：自动识别内网部署场景并调整限制策略

**影响评估**:
- ✅ **低风险**：只影响异常频繁的请求
- ✅ **向后兼容**：正常用户不受影响
- ✅ **内网友好**：内网部署时自动放宽 IP 限制，主要依赖相册限制
- ✅ **立即生效**：无需数据库迁移

**测试建议**:
```bash
# 测试速率限制是否生效（应该在第 11 次请求时被阻止）
for i in {1..15}; do
  curl -X POST https://your-domain.com/api/public/albums/test-slug/verify-password \
    -H "Content-Type: application/json" \
    -d '{"password":"wrong"}'
  sleep 1
done
```

**部署状态**: ✅ 已完成，可立即部署

---

## 🔍 待评估的修复

### 2. Worker API 代理认证

**当前状态**:
- Worker API 代理 (`/api/worker/[...path]/route.ts`) 没有认证检查
- Worker 服务本身也没有认证（只有 CORS）

**风险评估**:
- ⚠️ **需要确认**：哪些端点需要认证，哪些不需要
- ⚠️ **影响范围**：可能影响正常的上传流程
- ⚠️ **建议**：先确认 Worker 服务的访问模式

**建议方案**:
1. **先确认使用场景**：
   - `/api/worker/presign` - 是否需要认证？
   - `/api/worker/health` - 健康检查，通常不需要认证
   - 其他端点 - 需要确认

2. **如果 Worker 服务在内网**：
   - 风险较低，可以暂不修复
   - 或者添加 IP 白名单

3. **如果 Worker 服务暴露在公网**：
   - 建议添加认证检查
   - 或者添加 API Key 验证

**建议操作**:
```bash
# 1. 检查 Worker API 的使用情况
grep -r "/api/worker" apps/web/src

# 2. 确认 Worker 服务的部署方式
# - 内网访问：风险低
# - 公网访问：需要认证
```

**部署建议**: ⚠️ **暂缓**，需要先评估影响

---

### 3. 相册密码加密存储

**当前状态**:
- 密码以明文形式存储在数据库中
- 代码中已注释建议使用 bcrypt

**风险评估**:
- ⚠️ **需要数据库迁移**：风险较高
- ⚠️ **影响范围**：所有现有密码需要重新设置或迁移
- ⚠️ **向后兼容**：需要同时支持明文和加密密码

**建议方案**:

#### 方案 A：渐进式迁移（推荐）

1. **第一阶段**：添加加密支持，同时支持明文和加密
   ```typescript
   // 验证密码时，先检查是否是加密的
   if (album.password.startsWith('$2')) {
     // bcrypt 加密的密码
     const isValid = await bcrypt.compare(password, album.password)
   } else {
     // 明文密码（向后兼容）
     const isValid = album.password === password
   }
   ```

2. **第二阶段**：新设置的密码自动加密
   ```typescript
   // 设置密码时自动加密
   const hashedPassword = await bcrypt.hash(password, 10)
   ```

3. **第三阶段**：后台任务迁移现有密码
   ```typescript
   // 定期任务：将明文密码迁移为加密密码
   // 注意：需要用户重新输入密码，或者使用临时密码
   ```

#### 方案 B：一次性迁移（风险较高）

1. 创建数据库迁移脚本
2. 为所有现有密码生成临时密码
3. 通知用户重新设置密码

**部署建议**: ⚠️ **暂缓**，需要详细的迁移计划

---

## 📋 修复优先级

### 高优先级（已完成）
1. ✅ **密码验证 API 速率限制** - 已修复，可立即部署

### 中优先级（需要评估）
1. ⚠️ **Worker API 代理认证** - 需要先确认使用场景
2. ⚠️ **相册密码加密存储** - 需要详细的迁移计划

### 低优先级（可选）
1. ⚠️ Turnstile 降级策略 - 当前策略适合私有系统
2. ⚠️ Redis 分布式速率限制 - 单服务器部署不受影响

---

## 🚀 部署建议

### 立即部署
- ✅ 密码验证 API 速率限制（已完成）

### 需要评估后再部署
- ⚠️ Worker API 代理认证（需要确认影响）
- ⚠️ 相册密码加密存储（需要迁移计划）

---

## 📝 部署检查清单

### 部署前
- [ ] 在测试环境验证修改
- [ ] 检查日志，确认没有异常
- [ ] 确认向后兼容性
- [ ] 准备回滚方案

### 部署后
- [ ] 监控错误日志
- [ ] 监控性能指标
- [ ] 检查用户反馈
- [ ] 确认功能正常

---

## 🔍 监控建议

### 关键指标
1. **密码验证 API**：
   - 速率限制触发次数
   - 429 错误率
   - 平均响应时间

2. **Worker API**：
   - 请求量
   - 错误率
   - 响应时间

3. **数据库**：
   - 查询性能
   - 连接数
   - 错误率

---

## 📚 参考资源

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js Security Best Practices](https://nextjs.org/docs/app/building-your-application/configuring/security-headers)
- [Supabase Security](https://supabase.com/docs/guides/platform/security)

---

**最后更新**: 2026-01-26
